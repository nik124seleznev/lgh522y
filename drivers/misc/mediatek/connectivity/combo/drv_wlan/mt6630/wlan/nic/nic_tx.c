/*
                                                                              
*/

/*                  
                                                             

                                                                               
                                                                
*/



/*
                   
  
                        
                                                            
              
  
                        
                                                            
              
  
                      
                                                         
                                                                   
                                                    
  
                        
                                                                          
                           
  
                      
                                                         
                                                    
  
                      
                                                         
                                       
                                   
  
                      
                                                         
                                  
                  
  
                      
                                                         
                                        
  
                      
                                                         
                            
                                                 
  
                      
                                                         
                                             
                                   
  
                      
                                                         
                              
  
                      
                                                         
                             
                                             
                              
  
                      
                                                         
                                           
                         
                                      
  
                   
                                                                             
                                   
  
                      
                                                         
    
  
                      
                                                         
                                       
                                    
  
                   
                                                                             
                                                                      
                                  
  
                      
                                                         
                                         
  
                      
                                                         
                                      
                 
                                                            
  
                      
                                                         
                                                            
  
                      
                                                         
                                                    
                                                
  
                   
                                                                             
                                                                               
  
                      
                                                         
                               
  
                      
                                                         
                             
  
                   
                                                                             
                                        
                             
  
                      
                                                         
                                      
  
                      
                                                         
                             
  
                      
                                                         
                                               
  
                      
                                                         
                            
  
                      
                                                         
                            
  
                   
                                                                                     
                                   
                                   
  
                      
                                                         
                                       
  
                      
                                                         
    
  
                      
                                                         
                                  
  
                      
                                                         
                                                  
  
                      
                                                         
    
  
                      
                                                         
    
  
                   
                                                                                     
                                          
                                            
  
                   
                                                                                              
                                        
  
                      
                                                         
                                                        
  
                      
                                                         
                                             
  
                      
                                                         
                                     
                
                   
                                
  
                   
                                                                                     
                               
                                                      
  
                      
                                                         
                                             
  
                      
                                                         
                               
  
                      
                                                         
                                 
  
                      
                                                         
                                  
  
                   
                                                                                     
                                          
   
                   
                                                                                     
                                  
   
                      
                                                             
                                                  
                                                                      
   
                   
                                                                                             
                                                                    
  
                        
       
                           
                                                      
  
                        
                                                                            
                         
  
                        
                                                                            
                                                     
  
                        
                                                                            
                     
  
                   
                                                                                                                                 
                                                                                            
  
                        
                                                       
                                                 
                                                                               
                     
  
                   
                                                                                                                                                 
                           
  
                   
                                                                                                                                                 
                                                          
                                                                                                           
  
                   
                                                                                                                                                         
                                                                           
  
                   
                                                                                                                                        
                                               
                                                            
   
  
                   
                                                                                                                                          
                                         
                                                                                                          
  
                   
                                                                                                             
                                                               
                                                                          
                                                                                   
  
                   
                                                                                                                                              
                                                        
  
                   
                                                                                                                                  
                                                                                                                          
  
                        
                                                                                 
                          
  
                   
                                                                                                               
                                                                                                                   
                                                     
                                                                                                            
  
                   
                                                                         
                                                                         
  
                   
                                                                                                
                                                                                 
  
                   
       
                                                                                                        
  
                   
       
                                                                                                                                  
  
                   
       
                                 
  
                   
       
                                                                  
  
                   
       
                             
  
                   
       
                                     
  
                        
       
                                                                    
                        
  
                        
       
    
  
                   
       
                                
  
                           
       
                                                    
                                              
  
                   
       
                                                             
  
                           
  
                          
  
                   
  
                                                                                                 
                                                                                                   
                                                                                                                         
  
                   
  
                                                                               
  
                        
                                        
                                  
  
                   
                                                    
                                                                    
  
                   
                                                    
                                                                                                                        
  
                        
                                        
                                              
  
                   
                                                    
                                                    
                                                               
                                                               
  
                   
                                                    
                                       
  
                   
                                                    
                                                                         
  
                      
                                                            
                                                              
  
                   
                                                    
                                                 
  
                   
                                                    
    
  
                   
                                                    
    
  
                   
                                                    
                                                    
  
                   
                                                    
                      
                                                                      
                                                           
                                         
                                          
  
                   
                                                    
                                         
  
                   
                                                    
                                                                             
  
                         
                                                
                                   
  
                   
                                                                     
                                                            
  
                   
                                                          
                            
  
                           
                                             
                                    
  
                   
                                                          
                                 
  
                           
                                             
                                     
  
                           
                                             
                                
  
                   
                                                          
                                                            
              
  
                  
                                                          
                                                                  
  
                   
                                                          
                                                                                                    
                                                                                  
  
                   
                                                          
                                                                  
  
                   
                                                          
                                                                               
  
                   
                                                          
                                                                     
  
                   
                                                          
                                                                              
                                                                            
                                                                                  
                                                
                                                                                           
                                                                          
  
                   
                                                          
                                                                                                            
                                                                                        
                                                                                          
  
                   
                                                          
                                             
  
                   
                                                          
                                             
                                                                                
                                                                                                                   
                                                             
  
                         
                                                          
                                             
  
                   
                                                          
                                                                                          
  
                   
                                                          
                                                
                                                                                                      
                                                                           
                                                                                   
                                                                            
                     
                                                                            
                               
                                                                            
                           
                                                                            
                                                                                                         
                                              
                                                                            
                                                                          
                                                                            
                                  
                                                                            
                     
                                                                            
                                                       
                                                                            
                                             
                                                                            
                       
                                                                            
                                   
                                                                            
                
                                                                            
                                        
                                                                            
                                                                               
                                                                            
                                                                                                                                                
                                                                            
                                                             
                                                                            
                                                                            
                                           
                                                                            
                                       
                                                                            
                                                                    
                                                                            
                                                       
                                                                            
                                                     
                                                                            
                                                                            
                               
                                                                            
                   
                                                                            
                            
                                                                            
                                                                            
                               
                                                                            
                     
                                                                            
                                     
                                                                            
                                                 
                                                                            
                                                                                                                       
                                                                            
                                                                             
                                                                            
                                                     
                                                                            
                                  
                                                                           
                  
                                                                           
                                               
                                                                           
                                    
                                                                           
                                                                                                                 
                                                                           
                                     
                                                                           
                    
                                                                           
                      
                                                                           
                    
  
*/

/*                                                                              
                                                     
                                                                                
*/

/*                                                                              
                                                          
                                                                                
*/
#include "precomp.h"
#include "que_mgt.h"


#ifdef UDP_SKT_WIFI
#include <linux/ftrace_event.h>
#endif

/*                                                                              
                                                
                                                                                
*/

/*                                                                              
                                                 
                                                                                
*/

/*                                                                              
                                                  
                                                                                
*/

static const TX_RESOURCE_CONTROL_T arTcResourceControl[TC_NUM] = {
    /*                                                         */
    /*                */
    {PORT_INDEX_LMAC,   MAC_TXQ_AC0_INDEX,  HIF_TX_AC0_INDEX},
    {PORT_INDEX_LMAC,   MAC_TXQ_AC1_INDEX,  HIF_TX_AC1_INDEX},
    {PORT_INDEX_LMAC,   MAC_TXQ_AC2_INDEX,  HIF_TX_AC2_INDEX},
    {PORT_INDEX_LMAC,   MAC_TXQ_AC3_INDEX,  HIF_TX_AC3_INDEX},
    {PORT_INDEX_MCU,    MCU_Q1_INDEX,       HIF_TX_CPU_INDEX},
    {PORT_INDEX_LMAC,   MAC_TXQ_AC4_INDEX,  HIF_TX_AC4_INDEX},

    /*                 */
#if NIC_TX_ENABLE_SECOND_HW_QUEUE    
    {PORT_INDEX_LMAC,   MAC_TXQ_AC10_INDEX, HIF_TX_AC10_INDEX},
    {PORT_INDEX_LMAC,   MAC_TXQ_AC11_INDEX, HIF_TX_AC11_INDEX},
    {PORT_INDEX_LMAC,   MAC_TXQ_AC12_INDEX, HIF_TX_AC12_INDEX},
    {PORT_INDEX_LMAC,   MAC_TXQ_AC13_INDEX, HIF_TX_AC13_INDEX},
    {PORT_INDEX_LMAC,   MAC_TXQ_AC14_INDEX, HIF_TX_AC14_INDEX},
#endif
};

/*                         */
static const TX_TC_TRAFFIC_SETTING_T arTcTrafficSettings[NET_TC_NUM] = {
    /*                                                                                                          */
    /*                                                                              */
	{NIC_TX_DESC_SHORT_FORMAT_LENGTH, NIC_TX_AC_BE_REMAINING_TX_TIME,
	 NIC_TX_DATA_DEFAULT_RETRY_COUNT_LIMIT},
	{NIC_TX_DESC_SHORT_FORMAT_LENGTH, NIC_TX_AC_BK_REMAINING_TX_TIME,
	 NIC_TX_DATA_DEFAULT_RETRY_COUNT_LIMIT},
	{NIC_TX_DESC_SHORT_FORMAT_LENGTH, NIC_TX_AC_VI_REMAINING_TX_TIME,
	 NIC_TX_DATA_DEFAULT_RETRY_COUNT_LIMIT},
	{NIC_TX_DESC_SHORT_FORMAT_LENGTH, NIC_TX_AC_VO_REMAINING_TX_TIME,
	 NIC_TX_DATA_DEFAULT_RETRY_COUNT_LIMIT},

    /*            */
	{NIC_TX_DESC_LONG_FORMAT_LENGTH, TX_DESC_TX_TIME_NO_LIMIT,
	 NIC_TX_MGMT_DEFAULT_RETRY_COUNT_LIMIT},
    
    /*                                */
	{NIC_TX_DESC_LONG_FORMAT_LENGTH, TX_DESC_TX_TIME_NO_LIMIT,
	 NIC_TX_DATA_DEFAULT_RETRY_COUNT_LIMIT},
};

/*                                                                              
                                                   
                                                                                
*/

/*                                                                              
                                             
                                                                                
*/

/*                                                                              
                                                            
                                                                                
*/

/*                                                                              
                                                
                                                                                
*/
/*                                                                            */
/* 
                                                                               
                                                     
 
                                                     
 
                
*/
/*                                                                            */
VOID nicTxInitialize(IN P_ADAPTER_T prAdapter)
{
    P_TX_CTRL_T prTxCtrl;
    PUINT_8 pucMemHandle;
    P_MSDU_INFO_T prMsduInfo;
    UINT_32 i;
    KAL_SPIN_LOCK_DECLARATION();

    DEBUGFUNC("nicTxInitialize");

    ASSERT(prAdapter);
    prTxCtrl = &prAdapter->rTxCtrl;

	/*                                                        */
    nicTxResetResource(prAdapter);

    prTxCtrl->pucTxCoalescingBufPtr = prAdapter->pucCoalescingBufCached;

	/*                                                         */
    QUEUE_INITIALIZE(&prTxCtrl->rFreeMsduInfoList);

    pucMemHandle = prTxCtrl->pucTxCached;
	for (i = 0; i < CFG_TX_MAX_PKT_NUM; i++) {
		prMsduInfo = (P_MSDU_INFO_T) pucMemHandle;
        kalMemZero(prMsduInfo, sizeof(MSDU_INFO_T));

        KAL_ACQUIRE_SPIN_LOCK(prAdapter, SPIN_LOCK_TX_MSDU_INFO_LIST);
		QUEUE_INSERT_TAIL(&prTxCtrl->rFreeMsduInfoList, (P_QUE_ENTRY_T) prMsduInfo);
        KAL_RELEASE_SPIN_LOCK(prAdapter, SPIN_LOCK_TX_MSDU_INFO_LIST);

        pucMemHandle += ALIGN_4(sizeof(MSDU_INFO_T));
    }

    ASSERT(prTxCtrl->rFreeMsduInfoList.u4NumElem == CFG_TX_MAX_PKT_NUM);
    /*                                                                          */
	ASSERT((UINT_32) (pucMemHandle - prTxCtrl->pucTxCached) == prTxCtrl->u4TxCachedSize);

    QUEUE_INITIALIZE(&prTxCtrl->rTxMgmtTxingQueue);
    prTxCtrl->i4TxMgmtPendingNum = 0;

#if CFG_HIF_STATISTICS
    prTxCtrl->u4TotalTxAccessNum = 0;
    prTxCtrl->u4TotalTxPacketNum = 0;
#endif

    prTxCtrl->i4PendingFwdFrameCount = 0;

    /*                   */
    /*                    */
    prAdapter->ucTxSeqNum = 0;
    /*          */
	for (i = 0; i < WTBL_SIZE; i++) {
        prAdapter->aucPidPool[i] = NIC_TX_DESC_DRIVER_PID_MIN;
    }

    prTxCtrl->u4PageSize = NIC_TX_PAGE_SIZE;

    qmInit(prAdapter);

    TX_RESET_ALL_CNTS(prTxCtrl);

    return;
} /*                          */

BOOLEAN nicTxSanityCheckResource(IN P_ADAPTER_T prAdapter) 
{
    P_TX_CTRL_T prTxCtrl;
    UINT_8 ucTC;
    UINT_32 ucTotalMaxResource = 0;
    UINT_32 ucTotalFreeResource = 0;
    BOOLEAN fgError = FALSE;

    if(prAdapter->rWifiVar.ucTxDbg & BIT(0)) {
        prTxCtrl = &prAdapter->rTxCtrl;

        prTxCtrl->u4TotalPageNum = 546;

        for(ucTC = TC0_INDEX; ucTC < TC_NUM; ucTC++) {
            ucTotalMaxResource += prTxCtrl->rTc.au2MaxNumOfPage[ucTC];
            ucTotalFreeResource += prTxCtrl->rTc.au2FreePageCount[ucTC];
            
            if(prTxCtrl->rTc.au2FreePageCount[ucTC] > prTxCtrl->u4TotalPageNum) {
                DBGLOG(TX, ERROR, ("%s:%u\n error\n", __FUNCTION__, __LINE__));
                fgError = TRUE;
            }

            if(prTxCtrl->rTc.au2MaxNumOfPage[ucTC] > prTxCtrl->u4TotalPageNum) {
                DBGLOG(TX, ERROR, ("%s:%u\n error\n", __FUNCTION__, __LINE__));
                fgError = TRUE;
            }

            if(prTxCtrl->rTc.au2FreePageCount[ucTC] > prTxCtrl->rTc.au2MaxNumOfPage[ucTC]) {
                DBGLOG(TX, ERROR, ("%s:%u\n error\n", __FUNCTION__, __LINE__));
                fgError = TRUE;
            }
        }

        if(ucTotalMaxResource != prTxCtrl->u4TotalPageNum) {
            DBGLOG(TX, ERROR, ("%s:%u\n error\n", __FUNCTION__, __LINE__));
            fgError = TRUE;
        }

        if(ucTotalMaxResource < ucTotalFreeResource) {
            DBGLOG(TX, ERROR, ("%s:%u\n error\n", __FUNCTION__, __LINE__));
            fgError = TRUE;
        }    

        if(ucTotalFreeResource > prTxCtrl->u4TotalPageNum) {
            DBGLOG(TX, ERROR, ("%s:%u\n error\n", __FUNCTION__, __LINE__));
            fgError = TRUE;
        }     

        if(fgError) {
            DBGLOG(TX, ERROR, ("Total resource[%u]\n", prTxCtrl->u4TotalPageNum));
            qmDumpQueueStatus(prAdapter);
        }
    }

    return !fgError;
}


/*                                                                            */
/* 
                                                                                    
                                                                                       
                                                                                 
 
                                                                     
                                                              
 
                                                                        
                                                          
*/
/*                                                                            */
WLAN_STATUS nicTxAcquireResource(IN P_ADAPTER_T prAdapter, IN UINT_8 ucTC, IN UINT_8 ucPageCount)
{
    P_TX_CTRL_T prTxCtrl;
    WLAN_STATUS u4Status = WLAN_STATUS_RESOURCES;
    KAL_SPIN_LOCK_DECLARATION();

    ASSERT(prAdapter);
    prTxCtrl = &prAdapter->rTxCtrl;

    KAL_ACQUIRE_SPIN_LOCK(prAdapter, SPIN_LOCK_TX_RESOURCE);

    if (prTxCtrl->rTc.au2FreePageCount[ucTC] >= ucPageCount) {

        prTxCtrl->rTc.au2FreePageCount[ucTC] -= ucPageCount;

		prTxCtrl->rTc.au2FreeBufferCount[ucTC] =
		    (prTxCtrl->rTc.au2FreePageCount[ucTC] / NIC_TX_MAX_PAGE_PER_FRAME);

		DBGLOG(TX, EVENT,
		       ("Acquire: TC%d AcquirePageCnt[%u] FreeBufferCnt[%u] FreePageCnt[%u]\n",
			ucTC, ucPageCount, prTxCtrl->rTc.au2FreeBufferCount[ucTC],
			prTxCtrl->rTc.au2FreePageCount[ucTC]));

        u4Status = WLAN_STATUS_SUCCESS;
    }
   
    KAL_RELEASE_SPIN_LOCK(prAdapter, SPIN_LOCK_TX_RESOURCE);

    return u4Status;

}				/*                                       */


/*                                                                            */
/* 
                                                                                    
                                                                                      
                                                           
 
                                                         
                                                  
 
                                                      
                                                          
*/
/*                                                                            */
WLAN_STATUS nicTxPollingResource(IN P_ADAPTER_T prAdapter, IN UINT_8 ucTC)
{
    P_TX_CTRL_T prTxCtrl;
    WLAN_STATUS u4Status = WLAN_STATUS_FAILURE;
    INT_32 i = NIC_TX_RESOURCE_POLLING_TIMEOUT;
    UINT_32 au4WTSR[8];

    ASSERT(prAdapter);
    prTxCtrl = &prAdapter->rTxCtrl;

    if (ucTC >= TC_NUM) {
        return WLAN_STATUS_FAILURE;
    }

    if (prTxCtrl->rTc.au2FreeBufferCount[ucTC] > 0) {
        return WLAN_STATUS_SUCCESS;
    }

    while (i-- > 0) {
        HAL_READ_TX_RELEASED_COUNT(prAdapter, au4WTSR);

		if (kalIsCardRemoved(prAdapter->prGlueInfo) == TRUE || fgIsBusAccessFailed == TRUE) {
            u4Status = WLAN_STATUS_FAILURE;
            break;
		} else if (nicTxReleaseResource(prAdapter, (PUINT_16) au4WTSR)) {
            if (prTxCtrl->rTc.au2FreeBufferCount[ucTC] > 0) {
                u4Status = WLAN_STATUS_SUCCESS;
                break;
			} else {
                kalMsleep(NIC_TX_RESOURCE_POLLING_DELAY_MSEC);
            }
		} else {
            kalMsleep(NIC_TX_RESOURCE_POLLING_DELAY_MSEC);
        }
    }

#if DBG
    {
		INT_32 i4Times = NIC_TX_RESOURCE_POLLING_TIMEOUT - (i + 1);

        if (i4Times) {
            DBGLOG(TX, TRACE, ("Polling MCR_WTSR delay %ld times, %ld msec\n",
					   i4Times,
					   (i4Times * NIC_TX_RESOURCE_POLLING_DELAY_MSEC)));
        }
    }
#endif /*     */

    return u4Status;

} /*                               */


/*                                                                            */
/* 
                                                                                    
                                                                                 
                                                   
 
                                                                     
                                                     
                                                                                 
 
                                                           
                                                    
*/
/*                                                                            */
BOOLEAN
nicTxCalculateResource(IN P_ADAPTER_T prAdapter,
		       IN UINT_16 * au2TxRlsCnt, OUT UINT_16 * au2FreeTcResource)
{
    P_TX_TCQ_STATUS_T prTcqStatus;
    BOOLEAN bStatus = FALSE;
    UINT_8 ucTcIdx;
    UINT_16 u2TotalTxDonePageCount = 0;
    UINT_16 u2TotalExtraTxDone = 0;
    UINT_16 au2UsedPageCount[TC_NUM]; 
    UINT_16 au2ExtraTxDone[TC_NUM];

    KAL_SPIN_LOCK_DECLARATION();

    ASSERT(prAdapter);
    prTcqStatus = &prAdapter->rTxCtrl.rTc;
    
    /*                     */
    if(prAdapter->rWifiVar.ucExtraTxDone) {
        KAL_ACQUIRE_SPIN_LOCK(prAdapter, SPIN_LOCK_TX_RESOURCE);
        for (ucTcIdx = TC0_INDEX; ucTcIdx < TC_NUM; ucTcIdx++) {
            au2UsedPageCount[ucTcIdx] = prTcqStatus->au2MaxNumOfPage[ucTcIdx] - prTcqStatus->au2FreePageCount[ucTcIdx];
        }
        KAL_RELEASE_SPIN_LOCK(prAdapter, SPIN_LOCK_TX_RESOURCE);
    }

    /*                                    */
    prTcqStatus->u2AvaliablePageCount += au2TxRlsCnt[HIF_TX_FFA_INDEX];
    for (ucTcIdx = TC0_INDEX; ucTcIdx < TC_NUM; ucTcIdx++) {

        /*                                            */
        prTcqStatus->au2TxDonePageCount[ucTcIdx] += au2TxRlsCnt[arTcResourceControl[ucTcIdx].ucHifTxQIndex];

        /*                             */
        if(prAdapter->rWifiVar.ucExtraTxDone) {
            /*                                                */
            if(prTcqStatus->au2TxDonePageCount[ucTcIdx] >= prTcqStatus->au2PreUsedPageCount[ucTcIdx]) {
                prTcqStatus->au2TxDonePageCount[ucTcIdx] -= prTcqStatus->au2PreUsedPageCount[ucTcIdx];
                prTcqStatus->au2PreUsedPageCount[ucTcIdx] = 0;
            }
            else {
                prTcqStatus->au2PreUsedPageCount[ucTcIdx] -= prTcqStatus->au2TxDonePageCount[ucTcIdx];
                prTcqStatus->au2TxDonePageCount[ucTcIdx] = 0;
            }
            
            /*                                                     */
            if(prTcqStatus->au2TxDonePageCount[ucTcIdx] >= au2UsedPageCount[ucTcIdx]) {
                prTcqStatus->au2TxDonePageCount[ucTcIdx] = au2UsedPageCount[ucTcIdx];
                au2ExtraTxDone[ucTcIdx] = 0;
            }
            else {
                au2ExtraTxDone[ucTcIdx] = au2UsedPageCount[ucTcIdx] - prTcqStatus->au2TxDonePageCount[ucTcIdx];
            }
            u2TotalExtraTxDone += au2ExtraTxDone[ucTcIdx];
        }
        
        u2TotalTxDonePageCount += prTcqStatus->au2TxDonePageCount[ucTcIdx];
        
    }

    DBGLOG(TX, TRACE, ("Tx Done INT result, FFA[%u] AC[%u:%u:%u:%u:%u] CPU[%u]\n", 
        au2TxRlsCnt[HIF_TX_FFA_INDEX],
        au2TxRlsCnt[HIF_TX_AC0_INDEX],
        au2TxRlsCnt[HIF_TX_AC1_INDEX],
        au2TxRlsCnt[HIF_TX_AC2_INDEX],
        au2TxRlsCnt[HIF_TX_AC3_INDEX],
			   au2TxRlsCnt[HIF_TX_AC4_INDEX], au2TxRlsCnt[HIF_TX_CPU_INDEX]));
#if 0
	DBGLOG(TX, TRACE,
	       ("Tx Done INT result, AC5/6[%u:%u] BMC/BCN[%u:%u] AC10~14[%u:%u:%u:%u:%u]\n",
		au2TxRlsCnt[HIF_TX_AC5_INDEX], au2TxRlsCnt[HIF_TX_AC6_INDEX],
		au2TxRlsCnt[HIF_TX_BMC_INDEX], au2TxRlsCnt[HIF_TX_BCN_INDEX],
		au2TxRlsCnt[HIF_TX_AC10_INDEX], au2TxRlsCnt[HIF_TX_AC11_INDEX],
		au2TxRlsCnt[HIF_TX_AC12_INDEX], au2TxRlsCnt[HIF_TX_AC13_INDEX],
        au2TxRlsCnt[HIF_TX_AC14_INDEX]));
#endif
    DBGLOG(TX, TRACE, ("Tx Done Page count, TC[%u:%u:%u:%u:%u:%u]\n", 
        prTcqStatus->au2TxDonePageCount[TC0_INDEX],
        prTcqStatus->au2TxDonePageCount[TC1_INDEX],
        prTcqStatus->au2TxDonePageCount[TC2_INDEX],
        prTcqStatus->au2TxDonePageCount[TC3_INDEX],
        prTcqStatus->au2TxDonePageCount[TC4_INDEX],
        prTcqStatus->au2TxDonePageCount[TC5_INDEX]));

    /*                              */
    if(prTcqStatus->u2AvaliablePageCount && u2TotalTxDonePageCount) {
        /*                                        */
        if(prTcqStatus->u2AvaliablePageCount >= u2TotalTxDonePageCount) {
            /*                         */
			kalMemCopy(au2FreeTcResource,
                prTcqStatus->au2TxDonePageCount, 
                sizeof(prTcqStatus->au2TxDonePageCount));

			kalMemZero(prTcqStatus->au2TxDonePageCount,
                sizeof(prTcqStatus->au2TxDonePageCount));

            prTcqStatus->u2AvaliablePageCount -= u2TotalTxDonePageCount;
		} else {
            /*                                 */
            ucTcIdx = prTcqStatus->ucNextTcIdx;
			while (prTcqStatus->u2AvaliablePageCount) {
                /*                                  */
				if (prTcqStatus->u2AvaliablePageCount >=
				    prTcqStatus->au2TxDonePageCount[ucTcIdx]) {
					au2FreeTcResource[ucTcIdx] =
					    prTcqStatus->au2TxDonePageCount[ucTcIdx];
					prTcqStatus->u2AvaliablePageCount -=
					    prTcqStatus->au2TxDonePageCount[ucTcIdx];
                    prTcqStatus->au2TxDonePageCount[ucTcIdx] = 0;
                
                    /*                         */
                    ucTcIdx++;
                    ucTcIdx %= TC_NUM;                    
                }
                /*                                                          */
                else {
					au2FreeTcResource[ucTcIdx] =
					    prTcqStatus->u2AvaliablePageCount;
					prTcqStatus->au2TxDonePageCount[ucTcIdx] -=
					    prTcqStatus->u2AvaliablePageCount;
                    prTcqStatus->u2AvaliablePageCount = 0;
                }
            }
            prTcqStatus->ucNextTcIdx = ucTcIdx;
        }
        bStatus = TRUE;
	} else {

    /*                                              */
    if(prTcqStatus->u2AvaliablePageCount && u2TotalExtraTxDone && prAdapter->rWifiVar.ucExtraTxDone) {
        if(prTcqStatus->u2AvaliablePageCount >= u2TotalExtraTxDone) {
            for (ucTcIdx = TC0_INDEX; ucTcIdx < TC_NUM; ucTcIdx++) {
                au2FreeTcResource[ucTcIdx] += au2ExtraTxDone[ucTcIdx];
                prTcqStatus->au2PreUsedPageCount[ucTcIdx] += au2ExtraTxDone[ucTcIdx];
                au2ExtraTxDone[ucTcIdx] = 0;
            }

            prTcqStatus->u2AvaliablePageCount -= u2TotalExtraTxDone;
        }
    else {
            /*                                 */
            ucTcIdx = prTcqStatus->ucNextTcIdx;
            while(prTcqStatus->u2AvaliablePageCount) {
                /*                                  */
                if(prTcqStatus->u2AvaliablePageCount >= au2ExtraTxDone[ucTcIdx]) {
                    au2FreeTcResource[ucTcIdx] += au2ExtraTxDone[ucTcIdx];
                    prTcqStatus->au2PreUsedPageCount[ucTcIdx] += au2ExtraTxDone[ucTcIdx];
                    prTcqStatus->u2AvaliablePageCount -= au2ExtraTxDone[ucTcIdx];
                    au2ExtraTxDone[ucTcIdx] = 0;
                
                    /*                         */
                    ucTcIdx++;
                    ucTcIdx %= TC_NUM;                    
                }
                /*                                                          */
                    au2FreeTcResource[ucTcIdx] += prTcqStatus->u2AvaliablePageCount;
                    prTcqStatus->au2PreUsedPageCount[ucTcIdx] += prTcqStatus->u2AvaliablePageCount;
                    au2ExtraTxDone[ucTcIdx] -= prTcqStatus->u2AvaliablePageCount;
                    prTcqStatus->u2AvaliablePageCount = 0;
                }
            }
            prTcqStatus->ucNextTcIdx = ucTcIdx;
        }
        bStatus = TRUE;
    }

    return bStatus;
}


/*                                                                            */
/* 
                                                                                    
                                                                                 
                                                   
 
                                                                     
                                                      
 
                
*/
/*                                                                            */
BOOLEAN nicTxReleaseResource(IN P_ADAPTER_T prAdapter, IN UINT_16 *au2TxRlsCnt)
{
    P_TX_TCQ_STATUS_T prTcqStatus;
    BOOLEAN bStatus = FALSE;
    UINT_32 i, u4BufferCountToBeFreed;
	UINT_16 au2FreeTcResource[TC_NUM] = { 0 };

    KAL_SPIN_LOCK_DECLARATION();

    ASSERT(prAdapter);
    prTcqStatus = &prAdapter->rTxCtrl.rTc;

    /*                           */
    if (nicTxCalculateResource(prAdapter, au2TxRlsCnt, au2FreeTcResource)) {
        
        /*                           */
        KAL_ACQUIRE_SPIN_LOCK(prAdapter, SPIN_LOCK_TX_RESOURCE);
        for (i = TC0_INDEX; i < TC_NUM; i++) {

            /*                   */
            prTcqStatus->au2FreePageCount[i] += au2FreeTcResource[i];
            
            /*                                      */
            /*                                    */
			u4BufferCountToBeFreed =
			    (prTcqStatus->au2FreePageCount[i] / NIC_TX_MAX_PAGE_PER_FRAME);
            prTcqStatus->au2FreeBufferCount[i] = u4BufferCountToBeFreed;

			if (au2FreeTcResource[i]) {
				DBGLOG(TX, EVENT,
				       ("Release: TC%lu ReturnPageCnt[%u] FreePageCnt[%u] FreeBufferCnt[%u]\n",
					i, au2FreeTcResource[i], prTcqStatus->au2FreePageCount[i],
                     prTcqStatus->au2FreeBufferCount[i]));
            }
        }
        KAL_RELEASE_SPIN_LOCK(prAdapter, SPIN_LOCK_TX_RESOURCE);
        bStatus = TRUE;
    }

    if(!nicTxSanityCheckResource(prAdapter))
        DBGLOG(TX, ERROR, ("Tx Done INT result, FFA[%u] AC[%u:%u:%u:%u:%u] CPU[%u]\n", 
            au2TxRlsCnt[HIF_TX_FFA_INDEX], au2TxRlsCnt[HIF_TX_AC0_INDEX],
            au2TxRlsCnt[HIF_TX_AC1_INDEX], au2TxRlsCnt[HIF_TX_AC2_INDEX],
            au2TxRlsCnt[HIF_TX_AC3_INDEX], au2TxRlsCnt[HIF_TX_AC4_INDEX], 
            au2TxRlsCnt[HIF_TX_CPU_INDEX]));        


	DBGLOG(TX, LOUD,
	       ("TCQ Status Free Page:Buf[%03u:%02u, %03u:%02u, %03u:%02u, %03u:%02u, %03u:%02u, %03u:%02u]\n",
        prTcqStatus->au2FreePageCount[TC0_INDEX],
        prTcqStatus->au2FreeBufferCount[TC0_INDEX],
        prTcqStatus->au2FreePageCount[TC1_INDEX],
        prTcqStatus->au2FreeBufferCount[TC1_INDEX],
        prTcqStatus->au2FreePageCount[TC2_INDEX],
        prTcqStatus->au2FreeBufferCount[TC2_INDEX],
        prTcqStatus->au2FreePageCount[TC3_INDEX],
        prTcqStatus->au2FreeBufferCount[TC3_INDEX],
        prTcqStatus->au2FreePageCount[TC4_INDEX],
        prTcqStatus->au2FreeBufferCount[TC4_INDEX],     
        prTcqStatus->au2FreePageCount[TC5_INDEX],
        prTcqStatus->au2FreeBufferCount[TC5_INDEX]));

    return bStatus;
} /*                               */


/*                                                                            */
/* 
                                                   
 
                                                                     
 
                             
*/
/*                                                                            */
WLAN_STATUS nicTxResetResource(IN P_ADAPTER_T prAdapter)
{
    P_TX_CTRL_T prTxCtrl;
    UINT_8 ucIdx;

    KAL_SPIN_LOCK_DECLARATION();

    DEBUGFUNC("nicTxResetResource");

    ASSERT(prAdapter);
    prTxCtrl = &prAdapter->rTxCtrl;

    KAL_ACQUIRE_SPIN_LOCK(prAdapter, SPIN_LOCK_TX_RESOURCE);

    /*                  */
    kalMemZero(prTxCtrl->rTc.au2TxDonePageCount, sizeof(prTxCtrl->rTc.au2TxDonePageCount));   
    kalMemZero(prTxCtrl->rTc.au2PreUsedPageCount, sizeof(prTxCtrl->rTc.au2PreUsedPageCount));
    
    prTxCtrl->rTc.ucNextTcIdx = TC0_INDEX;
    prTxCtrl->rTc.u2AvaliablePageCount = 0;

    DBGLOG(TX, INFO, ("Default TCQ free resource [%u %u %u %u %u %u]\n", 
        prAdapter->rWifiVar.au4TcPageCount[TC0_INDEX],
        prAdapter->rWifiVar.au4TcPageCount[TC1_INDEX],
        prAdapter->rWifiVar.au4TcPageCount[TC2_INDEX],
        prAdapter->rWifiVar.au4TcPageCount[TC3_INDEX],
        prAdapter->rWifiVar.au4TcPageCount[TC4_INDEX],
        prAdapter->rWifiVar.au4TcPageCount[TC5_INDEX]));

    prAdapter->rTxCtrl.u4TotalPageNum = 0;
    prAdapter->rTxCtrl.u4TotalTxRsvPageNum = 0;

    for(ucIdx = TC0_INDEX; ucIdx < TC_NUM; ucIdx++) {
        /*            */
        prTxCtrl->rTc.au2MaxNumOfPage[ucIdx] = prAdapter->rWifiVar.au4TcPageCount[ucIdx];
        prTxCtrl->rTc.au2FreePageCount[ucIdx] = prAdapter->rWifiVar.au4TcPageCount[ucIdx];

        DBGLOG(TX, INFO, ("Set TC%u Default[%u] Max[%u] Free[%u]\n", 
            ucIdx,
            prAdapter->rWifiVar.au4TcPageCount[ucIdx],
            prTxCtrl->rTc.au2MaxNumOfPage[ucIdx],
            prTxCtrl->rTc.au2FreePageCount[ucIdx]));

        /*              */
        prTxCtrl->rTc.au2MaxNumOfBuffer[ucIdx] = (prTxCtrl->rTc.au2MaxNumOfPage[ucIdx] / NIC_TX_MAX_PAGE_PER_FRAME);
        prTxCtrl->rTc.au2FreeBufferCount[ucIdx] = (prTxCtrl->rTc.au2FreePageCount[ucIdx] / NIC_TX_MAX_PAGE_PER_FRAME);

        DBGLOG(TX, INFO, ("Set TC%u Default[%u] Buffer Max[%u] Free[%u]\n", 
            ucIdx,
            prAdapter->rWifiVar.au4TcPageCount[ucIdx],
            prTxCtrl->rTc.au2MaxNumOfBuffer[ucIdx],
            prTxCtrl->rTc.au2FreeBufferCount[ucIdx]));       

        prAdapter->rTxCtrl.u4TotalPageNum += prTxCtrl->rTc.au2MaxNumOfPage[ucIdx];
    }

    KAL_RELEASE_SPIN_LOCK(prAdapter, SPIN_LOCK_TX_RESOURCE);

    DBGLOG(TX, INFO, ("Reset TCQ free resource to Page:Buf [%u:%u %u:%u %u:%u %u:%u %u:%u %u:%u ]\n", 
        prTxCtrl->rTc.au2FreePageCount[TC0_INDEX],
        prTxCtrl->rTc.au2FreeBufferCount[TC0_INDEX],
        prTxCtrl->rTc.au2FreePageCount[TC1_INDEX],
        prTxCtrl->rTc.au2FreeBufferCount[TC1_INDEX],
        prTxCtrl->rTc.au2FreePageCount[TC2_INDEX],
        prTxCtrl->rTc.au2FreeBufferCount[TC2_INDEX],
        prTxCtrl->rTc.au2FreePageCount[TC3_INDEX],
        prTxCtrl->rTc.au2FreeBufferCount[TC3_INDEX],
        prTxCtrl->rTc.au2FreePageCount[TC4_INDEX],
        prTxCtrl->rTc.au2FreeBufferCount[TC4_INDEX],
        prTxCtrl->rTc.au2FreePageCount[TC5_INDEX],
        prTxCtrl->rTc.au2FreeBufferCount[TC5_INDEX]));
    
    DBGLOG(TX, INFO, ("Reset TCQ MAX resource to Page:Buf [%u:%u %u:%u %u:%u %u:%u %u:%u %u:%u]\n", 
        prTxCtrl->rTc.au2MaxNumOfPage[TC0_INDEX],
        prTxCtrl->rTc.au2MaxNumOfBuffer[TC0_INDEX],
        prTxCtrl->rTc.au2MaxNumOfPage[TC1_INDEX],
        prTxCtrl->rTc.au2MaxNumOfBuffer[TC1_INDEX],
        prTxCtrl->rTc.au2MaxNumOfPage[TC2_INDEX],
        prTxCtrl->rTc.au2MaxNumOfBuffer[TC2_INDEX],
        prTxCtrl->rTc.au2MaxNumOfPage[TC3_INDEX],
        prTxCtrl->rTc.au2MaxNumOfBuffer[TC3_INDEX],
        prTxCtrl->rTc.au2MaxNumOfPage[TC4_INDEX],
        prTxCtrl->rTc.au2MaxNumOfBuffer[TC4_INDEX],
        prTxCtrl->rTc.au2MaxNumOfPage[TC5_INDEX],
        prTxCtrl->rTc.au2MaxNumOfBuffer[TC5_INDEX]));    

    return WLAN_STATUS_SUCCESS;
}


/*                                                                            */
/* 
                                                                                    
                                                                                 
                                                          
 
                                                         
                                                  
 
                                                             
*/
/*                                                                            */
UINT_16 nicTxGetResource(IN P_ADAPTER_T prAdapter, IN UINT_8 ucTC)
{
    P_TX_CTRL_T prTxCtrl;

    ASSERT(prAdapter);
    prTxCtrl = &prAdapter->rTxCtrl;

    ASSERT(prTxCtrl);

    if (ucTC >= TC_NUM) {
        return 0;
	} else {
        return prTxCtrl->rTc.au2FreeBufferCount[ucTC];
    }
}

UINT_8 nicTxGetFrameResourceType(IN UINT_8 eFrameType, IN P_MSDU_INFO_T prMsduInfo)
{
    UINT_8 ucTC;

	switch (eFrameType) {
        case FRAME_TYPE_802_1X:
            ucTC = TC4_INDEX;
            break;

        case FRAME_TYPE_MMPDU:
		if (prMsduInfo) {
                ucTC = prMsduInfo->ucTC;
		} else {
                ucTC = TC4_INDEX;
            }
            break;

        default:
            DBGLOG(INIT, WARN, ("Undefined Frame Type(%u)\n", eFrameType));
            ucTC = TC4_INDEX;
            break;
    }

    return ucTC;    
}

UINT_8 nicTxGetCmdResourceType(IN P_CMD_INFO_T prCmdInfo)
{
    UINT_8 ucTC;

	switch (prCmdInfo->eCmdType) {
        case COMMAND_TYPE_NETWORK_IOCTL:
        case COMMAND_TYPE_GENERAL_IOCTL:
            ucTC = TC4_INDEX;
            break;
            
        case COMMAND_TYPE_SECURITY_FRAME:
            ucTC = nicTxGetFrameResourceType(FRAME_TYPE_802_1X, NULL);
            break;
            
        case COMMAND_TYPE_MANAGEMENT_FRAME:
		ucTC =
		    nicTxGetFrameResourceType(FRAME_TYPE_MMPDU,
					      (P_MSDU_INFO_T) prCmdInfo->prPacket);
            break;

        default:
            DBGLOG(INIT, WARN, ("Undefined CMD Type(%u)\n", prCmdInfo->eCmdType));
            ucTC = TC4_INDEX;
            break;
    }

    return ucTC;
}

/*                                                                            */
/* 
                                                               
                              
 
                                                                 
                                                            
 
                                              
                                                
*/
/*                                                                            */
WLAN_STATUS nicTxMsduInfoList(IN P_ADAPTER_T prAdapter, IN P_MSDU_INFO_T prMsduInfoListHead)
{
    P_MSDU_INFO_T prMsduInfo, prNextMsduInfo;
    QUE_T qDataPort0, qDataPort1;
    P_QUE_T prDataPort0, prDataPort1;
    WLAN_STATUS status;

    ASSERT(prAdapter);
    ASSERT(prMsduInfoListHead);

    prMsduInfo = prMsduInfoListHead;

    prDataPort0 = &qDataPort0;
    prDataPort1 = &qDataPort1;

    QUEUE_INITIALIZE(prDataPort0);
    QUEUE_INITIALIZE(prDataPort1);

	/*                                                                   */
	while (prMsduInfo) {
		prNextMsduInfo = (P_MSDU_INFO_T) QUEUE_GET_NEXT_ENTRY((P_QUE_ENTRY_T) prMsduInfo);

		switch (prMsduInfo->ucTC) {
        case TC0_INDEX:
        case TC1_INDEX:
        case TC2_INDEX:
        case TC3_INDEX:
		case TC5_INDEX:	/*                                  */
			QUEUE_GET_NEXT_ENTRY((P_QUE_ENTRY_T) prMsduInfo) = NULL;
			QUEUE_INSERT_TAIL(prDataPort0, (P_QUE_ENTRY_T) prMsduInfo);
			status =
			    nicTxAcquireResource(prAdapter, prMsduInfo->ucTC,
						 nicTxGetPageCount(prMsduInfo->u2FrameLength,
								   FALSE));
			ASSERT(status == WLAN_STATUS_SUCCESS);

            break;

		case TC4_INDEX:	/*                    */
			QUEUE_GET_NEXT_ENTRY((P_QUE_ENTRY_T) prMsduInfo) = NULL;
			QUEUE_INSERT_TAIL(prDataPort1, (P_QUE_ENTRY_T) prMsduInfo);

			status =
			    nicTxAcquireResource(prAdapter, prMsduInfo->ucTC,
						 nicTxGetPageCount(prMsduInfo->u2FrameLength,
								   FALSE));
			ASSERT(status == WLAN_STATUS_SUCCESS);

            break;

        default:
            ASSERT(0);
            break;
        }

        prMsduInfo = prNextMsduInfo;
    }

	if (prDataPort0->u4NumElem > 0) {
        nicTxMsduQueue(prAdapter, 0, prDataPort0);
    }

	if (prDataPort1->u4NumElem > 0) {
        nicTxMsduQueue(prAdapter, 1, prDataPort1);
    }

    return WLAN_STATUS_SUCCESS;
}

#if CFG_SUPPORT_MULTITHREAD
/*                                                                            */
/* 
                                                               
                              
 
                                                                 
                                                            
 
                                              
                                                
*/
/*                                                                            */
WLAN_STATUS nicTxMsduInfoListMthread(IN P_ADAPTER_T prAdapter, IN P_MSDU_INFO_T prMsduInfoListHead)
{
    P_MSDU_INFO_T prMsduInfo, prNextMsduInfo;
    QUE_T qDataPort0, qDataPort1;
    P_QUE_T prDataPort0, prDataPort1;

    KAL_SPIN_LOCK_DECLARATION();

    ASSERT(prAdapter);
    ASSERT(prMsduInfoListHead);

    prMsduInfo = prMsduInfoListHead;

    prDataPort0 = &qDataPort0;
    prDataPort1 = &qDataPort1;

    QUEUE_INITIALIZE(prDataPort0);
    QUEUE_INITIALIZE(prDataPort1);

	/*                                                                   */
	while (prMsduInfo) {
		prNextMsduInfo = (P_MSDU_INFO_T) QUEUE_GET_NEXT_ENTRY((P_QUE_ENTRY_T) prMsduInfo);

		switch (prMsduInfo->ucTC) {
        case TC0_INDEX:
        case TC1_INDEX:
        case TC2_INDEX:
        case TC3_INDEX:
		case TC5_INDEX:	/*                                  */
			QUEUE_GET_NEXT_ENTRY((P_QUE_ENTRY_T) prMsduInfo) = NULL;
			QUEUE_INSERT_TAIL(prDataPort0, (P_QUE_ENTRY_T) prMsduInfo);
            break;

		case TC4_INDEX:	/*                    */
			QUEUE_GET_NEXT_ENTRY((P_QUE_ENTRY_T) prMsduInfo) = NULL;
			QUEUE_INSERT_TAIL(prDataPort1, (P_QUE_ENTRY_T) prMsduInfo);
            break;

        default:
            ASSERT(0);
            break;
        }

        nicTxFillDesc(prAdapter, prMsduInfo, prMsduInfo->ucTxDescBuffer, NULL);

        prMsduInfo = prNextMsduInfo;
    }

	if (prDataPort0->u4NumElem > 0 || prDataPort1->u4NumElem > 0) {

        KAL_ACQUIRE_SPIN_LOCK(prAdapter, SPIN_LOCK_TX_PORT_QUE);
        QUEUE_CONCATENATE_QUEUES((&(prAdapter->rTxP0Queue)), (prDataPort0));
        QUEUE_CONCATENATE_QUEUES((&(prAdapter->rTxP1Queue)), (prDataPort1));
        KAL_RELEASE_SPIN_LOCK(prAdapter, SPIN_LOCK_TX_PORT_QUE);

        kalSetTxEvent2Hif(prAdapter->prGlueInfo);
    }

    return WLAN_STATUS_SUCCESS;
}

/*                                                                            */
/* 
                                                                                            
 
                                                                 
 
                                              
                                                
*/
/*                                                                            */
UINT_32 nicTxMsduQueueMthread(IN P_ADAPTER_T prAdapter)
{
    QUE_T qDataPort0, qDataPort1;
    P_QUE_T prDataPort0, prDataPort1;
    UINT_32 u4TxLoopCount;
    
    KAL_SPIN_LOCK_DECLARATION();

    prDataPort0 = &qDataPort0;
    prDataPort1 = &qDataPort1;

    QUEUE_INITIALIZE(prDataPort0);
    QUEUE_INITIALIZE(prDataPort1);
    
    u4TxLoopCount = prAdapter->rWifiVar.u4HifTxloopCount;

    while(u4TxLoopCount--) {

        while(QUEUE_IS_NOT_EMPTY((&(prAdapter->rTxP0Queue)))) {
    KAL_ACQUIRE_SPIN_LOCK(prAdapter, SPIN_LOCK_TX_PORT_QUE);
    QUEUE_MOVE_ALL((prDataPort0), (&(prAdapter->rTxP0Queue)));
    KAL_RELEASE_SPIN_LOCK(prAdapter, SPIN_LOCK_TX_PORT_QUE);

        nicTxMsduQueue(prAdapter, 0, prDataPort0);
    }

        while(QUEUE_IS_NOT_EMPTY((&(prAdapter->rTxP1Queue)))) {
            KAL_ACQUIRE_SPIN_LOCK(prAdapter, SPIN_LOCK_TX_PORT_QUE);
            QUEUE_MOVE_ALL((prDataPort1), (&(prAdapter->rTxP1Queue)));
            KAL_RELEASE_SPIN_LOCK(prAdapter, SPIN_LOCK_TX_PORT_QUE);

            nicTxMsduQueue(prAdapter, 1, prDataPort0);
    }
    }
    
    return WLAN_STATUS_SUCCESS;
}
#endif


/*                                                                            */
/* 
                                                                       
 
                                                                 
                                                        
                                                                   
 
              
*/
/*                                                                            */
VOID
nicTxComposeDesc(IN P_ADAPTER_T prAdapter,
    IN P_MSDU_INFO_T        prMsduInfo,
		 IN UINT_8 ucTxDescLength, IN BOOLEAN fgIsTemplate, OUT PUINT_8 prTxDescBuffer)
{
    P_HW_MAC_TX_DESC_T prTxDesc;
    P_STA_RECORD_T prStaRec;
    P_BSS_INFO_T prBssInfo;
    UINT_8 ucEtherTypeOffsetInWord;
    UINT_8 ucTxDescAndPaddingLength;

	prTxDesc = (P_HW_MAC_TX_DESC_T) prTxDescBuffer;
    prBssInfo = GET_BSS_INFO_BY_INDEX(prAdapter, prMsduInfo->ucBssIndex);
    prStaRec = cnmGetStaRecByIndex(prAdapter, prMsduInfo->ucStaRecIndex);

    ucTxDescAndPaddingLength = ucTxDescLength + NIC_TX_DESC_PADDING_LENGTH;
    
    kalMemZero(prTxDesc, ucTxDescAndPaddingLength);

    /*                       */
	/*               */
	/*                                                                                                    */

	/*                   */
    if (prMsduInfo->fgIs802_11) {
        ucEtherTypeOffsetInWord =
		    (NIC_TX_DESC_AND_PADDING_LENGTH + prMsduInfo->ucMacHeaderLength +
		     prMsduInfo->ucLlcLength) >> 1;
	} else {
        ucEtherTypeOffsetInWord =
            ((ETHER_HEADER_LEN - ETHER_TYPE_LEN) + ucTxDescAndPaddingLength) >> 1;
    }    
    HAL_MAC_TX_DESC_SET_ETHER_TYPE_OFFSET(prTxDesc, ucEtherTypeOffsetInWord);

	/*                          */
	HAL_MAC_TX_DESC_SET_PORT_INDEX(prTxDesc,
				       arTcResourceControl[prMsduInfo->ucTC].ucDestPortIndex);
	HAL_MAC_TX_DESC_SET_QUEUE_INDEX(prTxDesc,
					arTcResourceControl[prMsduInfo->ucTC].ucDestQueueIndex);

    /*            */
	if (prMsduInfo->ucStaRecIndex == STA_REC_INDEX_BMCAST) {
        HAL_MAC_TX_DESC_SET_BMC(prTxDesc);
        
        /*                                         */
        HAL_MAC_TX_DESC_SET_NO_ACK(prTxDesc);            
    }
	/*            */
	prMsduInfo->ucWlanIndex =
	    nicTxGetWlanIdx(prAdapter, prMsduInfo->ucBssIndex, prMsduInfo->ucStaRecIndex);

#if DBG
	DBGLOG(RSN, TRACE,
	       ("Tx WlanIndex = %d eAuthMode = %d\n", prMsduInfo->ucWlanIndex,
		prAdapter->rWifiVar.rConnSettings.eAuthMode));
#endif    
    HAL_MAC_TX_DESC_SET_WLAN_INDEX(prTxDesc, prMsduInfo->ucWlanIndex);

	/*               */
    if (prMsduInfo->fgIs802_11) {
        HAL_MAC_TX_DESC_SET_HEADER_FORMAT(prTxDesc, HEADER_FORMAT_802_11_NORMAL_MODE);
		HAL_MAC_TX_DESC_SET_802_11_HEADER_LENGTH(prTxDesc,
							 (prMsduInfo->ucMacHeaderLength >> 1));
	} else {
        HAL_MAC_TX_DESC_SET_HEADER_FORMAT(prTxDesc, HEADER_FORMAT_NON_802_11);
        HAL_MAC_TX_DESC_SET_ETHERNET_II(prTxDesc);
    }

	/*                */
    HAL_MAC_TX_DESC_SET_HEADER_PADDING(prTxDesc, NIC_TX_DESC_HEADER_PADDING_LENGTH);
    
	/*     */
    HAL_MAC_TX_DESC_SET_TID(prTxDesc, prMsduInfo->ucUserPriority);

	/*            */
	if (secIsProtectedFrame(prAdapter, prMsduInfo, prStaRec)) {
        /*                                                                        */
        nicTxConfigPktOption(prMsduInfo, MSDU_OPT_PROTECTED_FRAME, TRUE);
    }
	/*         */
    HAL_MAC_TX_DESC_SET_OWN_MAC_INDEX(prTxDesc, prBssInfo->ucOwnMacIndex);

	if (ucTxDescLength == NIC_TX_DESC_SHORT_FORMAT_LENGTH) {
        HAL_MAC_TX_DESC_SET_SHORT_FORMAT(prTxDesc);
        
		/*                      */
        nicTxFillDescByPktOption(prMsduInfo, prTxDesc);
        
        /*                           */
        return;
	} else {
        HAL_MAC_TX_DESC_SET_LONG_FORMAT(prTxDesc);
        
		/*                      */
        nicTxFillDescByPktOption(prMsduInfo, prTxDesc);   

        nicTxFillDescByPktControl(prMsduInfo, prTxDesc);
    }

	/*      */
    if (prMsduInfo->fgIs802_11) {
        P_WLAN_MAC_HEADER_T prWlanHeader = 
		    (P_WLAN_MAC_HEADER_T) ((ULONG) (prMsduInfo->prPacket) + MAC_TX_RESERVED_FIELD);
                    
        HAL_MAC_TX_DESC_SET_TYPE(prTxDesc, (prWlanHeader->u2FrameCtrl & MASK_FC_TYPE) >> 2);
		HAL_MAC_TX_DESC_SET_SUB_TYPE(prTxDesc,
					     (prWlanHeader->
					      u2FrameCtrl & MASK_FC_SUBTYPE) >>
					     OFFSET_OF_FC_SUBTYPE);
    }   
	/*     */
	if (prMsduInfo->pfTxDoneHandler) {
        prMsduInfo->ucPID = nicTxAssignPID(prAdapter, prMsduInfo->ucWlanIndex);
        HAL_MAC_TX_DESC_SET_PID(prTxDesc, prMsduInfo->ucPID);
        HAL_MAC_TX_DESC_SET_TXS_TO_MCU(prTxDesc);
    }
	/*                   */
	if (!(prMsduInfo->u4Option & MSDU_OPT_MANUAL_LIFE_TIME)) {
		prMsduInfo->u4RemainingLifetime =
		    arTcTrafficSettings[prMsduInfo->ucTC].u4RemainingTxTime;
    }
    HAL_MAC_TX_DESC_SET_REMAINING_LIFE_TIME_IN_MS(prTxDesc, prMsduInfo->u4RemainingLifetime);

	/*                */
	if (!(prMsduInfo->u4Option & MSDU_OPT_MANUAL_RETRY_LIMIT)) {
        /*                                                  */
        prMsduInfo->ucRetryLimit = arTcTrafficSettings[prMsduInfo->ucTC].ucTxCountLimit;
    }      
    HAL_MAC_TX_DESC_SET_REMAINING_TX_COUNT(prTxDesc, prMsduInfo->ucRetryLimit);

	/*              */
    HAL_MAC_TX_DESC_SET_POWER_OFFSET(prTxDesc, prMsduInfo->cPowerOffset);

	/*          */
	switch (prMsduInfo->ucRateMode) {
        case MSDU_RATE_MODE_MANUAL_DESC:
            HAL_MAC_TX_DESC_SET_DW(prTxDesc, 6, 1, &prMsduInfo->u4FixedRateOption);
            HAL_MAC_TX_DESC_SET_FIXED_RATE_MODE_TO_DESC(prTxDesc);
            HAL_MAC_TX_DESC_SET_FIXED_RATE_ENABLE(prTxDesc);
            break;
            
        case MSDU_RATE_MODE_MANUAL_CR:
            HAL_MAC_TX_DESC_SET_FIXED_RATE_MODE_TO_CR(prTxDesc);
            HAL_MAC_TX_DESC_SET_FIXED_RATE_ENABLE(prTxDesc);
            break;
            
        case MSDU_RATE_MODE_AUTO:
        default:
            break;
    }
    
}

VOID
nicTxComposeSecurityFrameDesc(IN P_ADAPTER_T prAdapter,
    IN P_CMD_INFO_T         prCmdInfo,
			      OUT PUINT_8 prTxDescBuffer, OUT PUINT_8 pucTxDescLength)
{
	P_HW_MAC_TX_DESC_T prTxDesc = (P_HW_MAC_TX_DESC_T) prTxDescBuffer;
	UINT_8 ucTxDescAndPaddingLength =
	    NIC_TX_DESC_LONG_FORMAT_LENGTH + NIC_TX_DESC_PADDING_LENGTH;
    P_STA_RECORD_T prStaRec = cnmGetStaRecByIndex(prAdapter, prCmdInfo->ucStaRecIndex);
    P_BSS_INFO_T prBssInfo;
    UINT_8 ucTid = 0;
    UINT_8 ucTempTC = TC4_INDEX;
    P_SEC_FRAME_INFO_T prSecFrameInfo;
    P_NATIVE_PACKET prNativePacket;
    UINT_8 ucEtherTypeOffsetInWord;

	prSecFrameInfo = (P_SEC_FRAME_INFO_T) prCmdInfo->pucInfoBuffer;

    prBssInfo = GET_BSS_INFO_BY_INDEX(prAdapter, prCmdInfo->ucBssIndex);            
    prNativePacket = prCmdInfo->prPacket;

    ASSERT(prNativePacket);

    kalMemZero(prTxDesc, ucTxDescAndPaddingLength);

	/*            */
	if (prStaRec) {
		/*                        */
        HAL_MAC_TX_DESC_SET_WLAN_INDEX(prTxDesc, prStaRec->ucWlanIndex);        
        /*                                 */
		/*                                                                           */
    }
	/*               */
	HAL_MAC_TX_DESC_SET_TX_BYTE_COUNT(prTxDesc,
					  ucTxDescAndPaddingLength + prCmdInfo->u2InfoBufLen);
    
	/*                   */
    ucEtherTypeOffsetInWord =
        ((ETHER_HEADER_LEN - ETHER_TYPE_LEN) + ucTxDescAndPaddingLength) >> 1; 
    HAL_MAC_TX_DESC_SET_ETHER_TYPE_OFFSET(prTxDesc, ucEtherTypeOffsetInWord);   
    
	/*                          */
    HAL_MAC_TX_DESC_SET_PORT_INDEX(prTxDesc, arTcResourceControl[ucTempTC].ucDestPortIndex);
    HAL_MAC_TX_DESC_SET_QUEUE_INDEX(prTxDesc, arTcResourceControl[ucTempTC].ucDestQueueIndex);

	/*                */
	if (prSecFrameInfo->fgIsProtected) {
        HAL_MAC_TX_DESC_SET_PROTECTION(prTxDesc);
    }
	/*               */
    HAL_MAC_TX_DESC_SET_HEADER_FORMAT(prTxDesc, HEADER_FORMAT_NON_802_11);

	/*             */
    HAL_MAC_TX_DESC_SET_LONG_FORMAT(prTxDesc);

	if (!GLUE_GET_PKT_IS_802_3(prNativePacket)) {
		/*                */
        HAL_MAC_TX_DESC_SET_ETHERNET_II(prTxDesc);
    }
	/*                */
    HAL_MAC_TX_DESC_SET_HEADER_PADDING(prTxDesc, NIC_TX_DESC_HEADER_PADDING_LENGTH);
  
	/*     */
    HAL_MAC_TX_DESC_SET_TID(prTxDesc, ucTid);

	/*                   */
	HAL_MAC_TX_DESC_SET_REMAINING_LIFE_TIME_IN_MS(prTxDesc,
						      arTcTrafficSettings[ucTempTC].
						      u4RemainingTxTime);

	/*                */
	HAL_MAC_TX_DESC_SET_REMAINING_TX_COUNT(prTxDesc,
					       arTcTrafficSettings[ucTempTC].ucTxCountLimit);

	/*         */
    HAL_MAC_TX_DESC_SET_OWN_MAC_INDEX(prTxDesc, prBssInfo->ucOwnMacIndex); 

	if (pucTxDescLength) {
        *pucTxDescLength = ucTxDescAndPaddingLength;
    }
}

/*                                                                            */
/* 
                                                                       
 
                                                                 
                                                        
                                                                   
 
              
*/
/*                                                                            */
VOID
nicTxFillDesc(IN P_ADAPTER_T prAdapter,
	      IN P_MSDU_INFO_T prMsduInfo, OUT PUINT_8 prTxDescBuffer, OUT PUINT_8 pucTxDescLength)
{
	P_HW_MAC_TX_DESC_T prTxDesc = (P_HW_MAC_TX_DESC_T) prTxDescBuffer;
    P_HW_MAC_TX_DESC_T prTxDescTemplate = NULL;
    P_STA_RECORD_T prStaRec = cnmGetStaRecByIndex(prAdapter, prMsduInfo->ucStaRecIndex);
    UINT_8 ucTxDescLength;
#if CFG_TCP_IP_CHKSUM_OFFLOAD
    UINT_8 ucChksumFlag = 0;
#endif

/*
                                                                               
                       
                                                                               
*/
    /*                                     */
	if (prMsduInfo->fgIsTXDTemplateValid && (prMsduInfo->ucControlFlag == 0) && prStaRec) {
        prTxDescTemplate = prStaRec->aprTxDescTemplate[prMsduInfo->ucUserPriority];
    
		if (HAL_MAC_TX_DESC_IS_LONG_FORMAT(prTxDescTemplate)) {
            ucTxDescLength = NIC_TX_DESC_LONG_FORMAT_LENGTH;
		} else {
            ucTxDescLength = NIC_TX_DESC_SHORT_FORMAT_LENGTH;
        }

		kalMemCopy(prTxDesc, prTxDescTemplate, ucTxDescLength);

        /*                                        */
        nicTxFillDescByPktOption(prMsduInfo, prTxDesc);
    }
    /*                          */
    else {
        ucTxDescLength = NIC_TX_DESC_LONG_FORMAT_LENGTH;
        nicTxComposeDesc(prAdapter, prMsduInfo, ucTxDescLength, FALSE, prTxDescBuffer);
    }
    
/*
                                                                               
                                                    
                                                                               
*/
    /*                         */
	HAL_MAC_TX_DESC_SET_TX_BYTE_COUNT(prTxDesc,
					  ucTxDescLength + NIC_TX_DESC_PADDING_LENGTH +
					  prMsduInfo->u2FrameLength);

    /*                  */
#if CFG_TCP_IP_CHKSUM_OFFLOAD
	if (prMsduInfo->eSrc == TX_PACKET_OS) {
		if (prAdapter->u4CSUMFlags &
		    (CSUM_OFFLOAD_EN_TX_TCP | CSUM_OFFLOAD_EN_TX_UDP | CSUM_OFFLOAD_EN_TX_IP)) {
            ASSERT(prMsduInfo->prPacket);                 
            kalQueryTxChksumOffloadParam(prMsduInfo->prPacket, &ucChksumFlag);
			if ((ucChksumFlag & TX_CS_IP_GEN)) {
                HAL_MAC_TX_DESC_SET_IP_CHKSUM(prTxDesc);
            }
			if ((ucChksumFlag & TX_CS_TCP_UDP_GEN)) {
                HAL_MAC_TX_DESC_SET_TCP_UDP_CHKSUM(prTxDesc);
            }               
        }
    }
#endif /*                           */    

    /*                                           */
	if (!prMsduInfo->fgIs802_11) {
		if (prMsduInfo->fgIs802_3) {
            HAL_MAC_TX_DESC_UNSET_ETHERNET_II(prTxDesc);
        }
		if (prMsduInfo->fgIsVlanExists) {
            HAL_MAC_TX_DESC_SET_VLAN(prTxDesc);
        }
    }

	if (pucTxDescLength) {
        *pucTxDescLength = ucTxDescLength;
    }
}

VOID
nicTxCopyDesc(IN P_ADAPTER_T prAdapter,
    IN P_HW_MAC_TX_DESC_T   prTarTxDesc,
	      IN P_HW_MAC_TX_DESC_T prSrcTxDesc, OUT PUINT_8 pucTxDescLength)
{
    UINT_8 ucTxDescLength;

	if (HAL_MAC_TX_DESC_IS_LONG_FORMAT((P_HW_MAC_TX_DESC_T) prSrcTxDesc)) {
        ucTxDescLength = NIC_TX_DESC_LONG_FORMAT_LENGTH;
	} else {
        ucTxDescLength = NIC_TX_DESC_SHORT_FORMAT_LENGTH;
    }
    
    kalMemCopy(prTarTxDesc, prSrcTxDesc, ucTxDescLength);

	if (pucTxDescLength) {
        *pucTxDescLength = ucTxDescLength;
    }
}

/*                                                                            */
/* 
                                                                              
 
                                                                 
                                                               
 
              
*/
/*                                                                            */
WLAN_STATUS nicTxGenerateDescTemplate(IN P_ADAPTER_T prAdapter, IN P_STA_RECORD_T prStaRec)
{
    UINT_8  ucTid;
    UINT_8  ucTc;
    UINT_8  ucTxDescSize;
    P_HW_MAC_TX_DESC_T  prTxDesc;
    P_TX_CTRL_T prTxCtrl;
    P_MSDU_INFO_T prMsduInfo;
    WLAN_STATUS rStatus = WLAN_STATUS_SUCCESS;

    KAL_SPIN_LOCK_DECLARATION();

    ASSERT(prAdapter);    

    /*                               */
	/*                                             */
	for (ucTid = 0; ucTid < TX_DESC_TID_NUM; ucTid++) {
        prStaRec->aprTxDescTemplate[ucTid] = NULL;
    }    

    prTxCtrl = &prAdapter->rTxCtrl;

    KAL_ACQUIRE_SPIN_LOCK(prAdapter, SPIN_LOCK_TX_MSDU_INFO_LIST);
    QUEUE_REMOVE_HEAD(&prTxCtrl->rFreeMsduInfoList, prMsduInfo, P_MSDU_INFO_T);
    KAL_RELEASE_SPIN_LOCK(prAdapter, SPIN_LOCK_TX_MSDU_INFO_LIST);

	if (!prMsduInfo) {
        return WLAN_STATUS_RESOURCES;
    }

    /*                           */   
    prMsduInfo->eSrc = TX_PACKET_OS;
    prMsduInfo->fgIs802_11 = FALSE;
    prMsduInfo->fgIs802_1x = FALSE;
    prMsduInfo->fgIs802_3 = FALSE;
    prMsduInfo->fgIsVlanExists = FALSE;
    prMsduInfo->pfTxDoneHandler = NULL;
    prMsduInfo->prPacket = NULL;
    prMsduInfo->u2FrameLength = 0;
    prMsduInfo->u4Option = 0;
    prMsduInfo->u4FixedRateOption = 0;
    prMsduInfo->ucRateMode = MSDU_RATE_MODE_AUTO;
    prMsduInfo->ucBssIndex = prStaRec->ucBssIndex;
    prMsduInfo->ucPacketType = TX_PACKET_TYPE_DATA;
    prMsduInfo->ucStaRecIndex = prStaRec->ucIndex;
    prMsduInfo->ucPID = NIC_TX_DESC_PID_RESERVED;

    ucTxDescSize = NIC_TX_DESC_SHORT_FORMAT_LENGTH;

	DBGLOG(QM, INFO,
	       ("Generate TXD template for STA[%u] QoS[%u]\n", prStaRec->ucIndex,
		prStaRec->fgIsQoS));

    /*                       */
	if (prStaRec->fgIsQoS) {
        /*                                                  */
		for (ucTid = 0; ucTid < TX_DESC_TID_NUM; ucTid++) {

			if (prAdapter->rWifiVar.ucTcRestrict < TC_NUM) {
                ucTc = prAdapter->rWifiVar.ucTcRestrict;
			} else {
				ucTc =
				    arNetwork2TcResource[prStaRec->ucBssIndex][aucTid2ACI[ucTid]];
            }
            ucTxDescSize = arTcTrafficSettings[ucTc].ucTxDescLength;
            
            prTxDesc = kalMemAlloc(ucTxDescSize, VIR_MEM_TYPE);
			if (!prTxDesc) {
                rStatus = WLAN_STATUS_RESOURCES;
                break;
            }
            
            /*                          */
            prMsduInfo->ucUserPriority = ucTid;
            prMsduInfo->ucTC = ucTc;

            /*                          */
			nicTxComposeDesc(prAdapter, prMsduInfo, ucTxDescSize, TRUE,
					 (PUINT_8) prTxDesc);

            prStaRec->aprTxDescTemplate[ucTid] = prTxDesc;
        }
	} else {
        /*                                                 */
		do {
			if (prAdapter->rWifiVar.ucTcRestrict < TC_NUM) {
                ucTc = prAdapter->rWifiVar.ucTcRestrict;
			} else {
				ucTc =
				    arNetwork2TcResource[prStaRec->
							 ucBssIndex]
				    [NET_TC_NON_STAREC_NON_QOS_INDEX];
            }
			/*                                                          */
            ucTxDescSize = NIC_TX_DESC_SHORT_FORMAT_LENGTH;
            
            prTxDesc = kalMemAlloc(ucTxDescSize, VIR_MEM_TYPE);
			if (!prTxDesc) {
                rStatus = WLAN_STATUS_RESOURCES;
                break;
            }
            /*                          */
            prMsduInfo->ucUserPriority = 0;
            prMsduInfo->ucTC = ucTc; 
            
            /*                          */
			nicTxComposeDesc(prAdapter, prMsduInfo, ucTxDescSize, TRUE,
					 (PUINT_8) prTxDesc);
            
			for (ucTid = 0; ucTid < TX_DESC_TID_NUM; ucTid++) {
                prStaRec->aprTxDescTemplate[ucTid] = prTxDesc;
				DBGLOG(QM, TRACE,
				       ("TXD template: TID[%u] Ptr[0x%x]\n", ucTid,
					(ULONG) prTxDesc));
            }
		} while (FALSE);
    }

    nicTxReturnMsduInfo(prAdapter, prMsduInfo);

    return rStatus;
}

/*                                                                            */
/* 
                                                                          
 
                                                                 
                                                               
 
              
*/
/*                                                                            */
VOID nicTxFreeDescTemplate(IN P_ADAPTER_T prAdapter, IN P_STA_RECORD_T prStaRec)
{
    UINT_8  ucTid;
    UINT_8  ucTxDescSize;
    P_HW_MAC_TX_DESC_T  prTxDesc;

	DBGLOG(QM, INFO,
	       ("Free TXD template for STA[%u] QoS[%u]\n", prStaRec->ucIndex, prStaRec->fgIsQoS));

	if (prStaRec->fgIsQoS) {
		for (ucTid = 0; ucTid < TX_DESC_TID_NUM; ucTid++) {
			prTxDesc = (P_HW_MAC_TX_DESC_T) prStaRec->aprTxDescTemplate[ucTid];
            
			if (prTxDesc) {
				if (HAL_MAC_TX_DESC_IS_LONG_FORMAT(prTxDesc)) {
                    ucTxDescSize = NIC_TX_DESC_LONG_FORMAT_LENGTH;
				} else {
                    ucTxDescSize = NIC_TX_DESC_SHORT_FORMAT_LENGTH;
                }
                
                kalMemFree(prTxDesc, VIR_MEM_TYPE, ucTxDescSize);
                
                prTxDesc = prStaRec->aprTxDescTemplate[ucTid] = NULL;
            }
        }
	} else {
		prTxDesc = (P_HW_MAC_TX_DESC_T) prStaRec->aprTxDescTemplate[0];
		if (prTxDesc) {
			if (HAL_MAC_TX_DESC_IS_LONG_FORMAT(prTxDesc)) {
                ucTxDescSize = NIC_TX_DESC_LONG_FORMAT_LENGTH;
			} else {
                ucTxDescSize = NIC_TX_DESC_SHORT_FORMAT_LENGTH;
            }
            
            kalMemFree(prTxDesc, VIR_MEM_TYPE, ucTxDescSize);
            prTxDesc = NULL;
        }        
		for (ucTid = 0; ucTid < TX_DESC_TID_NUM; ucTid++) {
            prStaRec->aprTxDescTemplate[ucTid] = NULL;
        }
    }
}

/*                                                                            */
/* 
                                                                     
 
                                                                 
                                           
                                                            
 
                                              
                                                
*/
/*                                                                            */
WLAN_STATUS nicTxMsduQueue(IN P_ADAPTER_T prAdapter, UINT_8 ucPortIdx, P_QUE_T prQue)
{
    P_MSDU_INFO_T prMsduInfo, prNextMsduInfo;
    P_NATIVE_PACKET prNativePacket;
	PUINT_8 pucOutputBuf = (PUINT_8) NULL;	/*                                          */
    UINT_8 ucTxDescSize;
    UINT_32 u4ValidBufSize;
    UINT_32 u4TotalLength;
    P_TX_CTRL_T prTxCtrl;
    QUE_T rFreeQueue;
    P_QUE_T prFreeQueue;
    PUINT_8 pucBufferTxD;
#if ((CFG_SDIO_TX_AGG == 1) && (CFG_SDIO_TX_AGG_LIMIT != 0))    
    BOOLEAN fgWriteNow;
#endif

    ASSERT(prAdapter);
    ASSERT(ucPortIdx < 2);
    ASSERT(prQue);

    prTxCtrl = &prAdapter->rTxCtrl;
    u4ValidBufSize = prAdapter->u4CoalescingBufCachedSize;

#if CFG_HIF_STATISTICS
    prTxCtrl->u4TotalTxAccessNum++;
    prTxCtrl->u4TotalTxPacketNum += prQue->u4NumElem;
#endif

    prFreeQueue = &rFreeQueue;

    QUEUE_INITIALIZE(prFreeQueue);

	if (prQue->u4NumElem > 0) {
		prMsduInfo = (P_MSDU_INFO_T) QUEUE_GET_HEAD(prQue);
        pucOutputBuf = prTxCtrl->pucTxCoalescingBufPtr;
        u4TotalLength = 0;

		while (prMsduInfo) {

            prNativePacket = prMsduInfo->prPacket;

            ASSERT(prNativePacket);
            
#if CFG_SUPPORT_MULTITHREAD
            nicTxCopyDesc(prAdapter, 
				      (P_HW_MAC_TX_DESC_T) (pucOutputBuf + u4TotalLength),
				      (P_HW_MAC_TX_DESC_T) prMsduInfo->ucTxDescBuffer,
                &ucTxDescSize);
#else
			nicTxFillDesc(prAdapter, prMsduInfo, (pucOutputBuf + u4TotalLength),
				      &ucTxDescSize);
#endif

            pucBufferTxD = (pucOutputBuf + u4TotalLength);
            
            u4TotalLength += (ucTxDescSize + NIC_TX_DESC_PADDING_LENGTH);

            if (prMsduInfo->eSrc == TX_PACKET_OS
                    || prMsduInfo->eSrc == TX_PACKET_FORWARDING) {
                kalCopyFrame(prAdapter->prGlueInfo,
					     prNativePacket, pucOutputBuf + u4TotalLength);
			} else if (prMsduInfo->eSrc == TX_PACKET_MGMT) {
                kalMemCopy(pucOutputBuf + u4TotalLength,
					   prNativePacket, prMsduInfo->u2FrameLength);
			} else {
                ASSERT(0);
            }                 

            u4TotalLength += ALIGN_4(prMsduInfo->u2FrameLength);

            prNextMsduInfo = (P_MSDU_INFO_T)
                        QUEUE_GET_NEXT_ENTRY(&prMsduInfo->rQueEntry);

            /*                */
            if (prMsduInfo->eSrc == TX_PACKET_MGMT) {
                GLUE_DEC_REF_CNT(prTxCtrl->i4TxMgmtPendingNum);

                if (prMsduInfo->pfTxDoneHandler == NULL) {
                    cnmMgtPktFree(prAdapter, prMsduInfo);
				} else {
                    KAL_SPIN_LOCK_DECLARATION();
					DBGLOG(REQ, INFO, ("Wait WIDX:PID[%u:%u] SEQ[%u]\n",
                        prMsduInfo->ucWlanIndex, 
                        prMsduInfo->ucPID,
                        prMsduInfo->ucTxSeqNum));
                    KAL_ACQUIRE_SPIN_LOCK(prAdapter, SPIN_LOCK_TXING_MGMT_LIST);
					QUEUE_INSERT_TAIL(&(prTxCtrl->rTxMgmtTxingQueue),
							  (P_QUE_ENTRY_T) prMsduInfo);
                    KAL_RELEASE_SPIN_LOCK(prAdapter, SPIN_LOCK_TXING_MGMT_LIST);
                }
			} else {
                /*                                            */
				QUEUE_INSERT_TAIL(prFreeQueue, (P_QUE_ENTRY_T) prMsduInfo);

                if (prMsduInfo->eSrc == TX_PACKET_OS) {
                    wlanTxProfilingTagMsdu(prAdapter, prMsduInfo, TX_PROF_TAG_DRV_TX_DONE);
                    kalSendComplete(prAdapter->prGlueInfo,
							prNativePacket, WLAN_STATUS_SUCCESS);

                    
				} else if (prMsduInfo->eSrc == TX_PACKET_FORWARDING) {
                    GLUE_DEC_REF_CNT(prTxCtrl->i4PendingFwdFrameCount);
                }
            }

#if (CFG_SDIO_TX_AGG == 0)
            ASSERT(u4TotalLength <= u4ValidBufSize);
            
            HAL_WRITE_TX_PORT(prAdapter,
					  u4TotalLength, (PUINT_8) pucOutputBuf, u4ValidBufSize);

			/*                    */
            u4TotalLength = 0;   

#elif ((CFG_SDIO_TX_AGG == 1) && (CFG_SDIO_TX_AGG_LIMIT != 0))
            fgWriteNow = TRUE;

			if (prNextMsduInfo) {
				if ((u4TotalLength + prNextMsduInfo->u2FrameLength +
				     NIC_TX_DESC_AND_PADDING_LENGTH) < CFG_SDIO_TX_AGG_LIMIT) {
                    fgWriteNow = FALSE;
                }
            }
            
            /*              */
			if (fgWriteNow) {
                ASSERT(u4TotalLength <= u4ValidBufSize);
                
                HAL_WRITE_TX_PORT(prAdapter,
                        u4TotalLength,
						  (PUINT_8) pucOutputBuf, u4ValidBufSize);

				/*                    */
                u4TotalLength = 0;   
            }            
#endif            

            prMsduInfo = prNextMsduInfo;
        } 

#if ((CFG_SDIO_TX_AGG == 1) && (CFG_SDIO_TX_AGG_LIMIT == 0))
        if(u4TotalLength > u4ValidBufSize) {
            DBGLOG(TX, ERROR, ("Tx Error! Port[%u] u4TotalLength[%u] > u4ValidBufSize[%u]\n", 
                ucPortIdx, u4TotalLength, u4ValidBufSize));
            
            DBGLOG(TX, ERROR, ("Tx Error! TxQ count[%u], FreeQ count[%u]\n", 
                prQue->u4NumElem, prFreeQueue->u4NumElem));

            prMsduInfo = (P_MSDU_INFO_T) QUEUE_GET_HEAD(prFreeQueue);
            DBGLOG(TX, ERROR, ("=== Dump MsduInfo ===\n"));            
            while(prMsduInfo) {

                DBGLOG(INIT, INFO, ("Msdu[0x%p] Src[%u] Len[%u] Bss[%u] Sta[%u] TC[%u]\n", 
                    prMsduInfo, prMsduInfo->eSrc, prMsduInfo->u2FrameLength, prMsduInfo->ucBssIndex,
                    prMsduInfo->ucStaRecIndex, prMsduInfo->ucTC));

                prMsduInfo = (P_MSDU_INFO_T)QUEUE_GET_NEXT_ENTRY(&prMsduInfo->rQueEntry);
            }
            DBGLOG(TX, ERROR, ("=== Dump done ===\n")); 
            
            qmDumpQueueStatus(prAdapter);
        }

        ASSERT(u4TotalLength <= u4ValidBufSize);
        
		HAL_WRITE_TX_PORT(prAdapter, u4TotalLength, (PUINT_8) pucOutputBuf, u4ValidBufSize);
#endif
		nicTxReturnMsduInfo(prAdapter, (P_MSDU_INFO_T) QUEUE_GET_HEAD(&rFreeQueue));

            }
      
    return WLAN_STATUS_SUCCESS;
}

/*                                                                            */
/* 
                                                                    
 
                                                         
                                             
                                                  
 
                                              
                                                
*/
/*                                                                            */
WLAN_STATUS nicTxCmd(IN P_ADAPTER_T prAdapter, IN P_CMD_INFO_T prCmdInfo, IN UINT_8 ucTC)
{
    P_WIFI_CMD_T prWifiCmd;
    UINT_16 u2OverallBufferLength;
    UINT_8 ucTxDescLength;
	PUINT_8 pucOutputBuf = (PUINT_8) NULL;	/*                                          */
    P_NATIVE_PACKET prNativePacket;
    P_MSDU_INFO_T prMsduInfo;
    P_TX_CTRL_T prTxCtrl;

    KAL_SPIN_LOCK_DECLARATION();

    ASSERT(prAdapter);
    ASSERT(prCmdInfo);

    prTxCtrl = &prAdapter->rTxCtrl;
    pucOutputBuf = prTxCtrl->pucTxCoalescingBufPtr;

	if (prCmdInfo->eCmdType == COMMAND_TYPE_SECURITY_FRAME) {
#if CFG_SUPPORT_MULTITHREAD
        nicTxCopyDesc(prAdapter, 
			      (P_HW_MAC_TX_DESC_T) &pucOutputBuf[0],
			      (P_HW_MAC_TX_DESC_T) ((P_SEC_FRAME_INFO_T) prCmdInfo->pucInfoBuffer)->
			      ucTxDescBuffer, &ucTxDescLength);
#else
		nicTxComposeSecurityFrameDesc(prAdapter, prCmdInfo, &pucOutputBuf[0],
            &ucTxDescLength);
#endif

        prNativePacket = prCmdInfo->prPacket;
		u2OverallBufferLength =
		    TFCB_FRAME_PAD_TO_DW((prCmdInfo->u2InfoBufLen + ucTxDescLength));

		/*                          */
		kalCopyFrame(prAdapter->prGlueInfo, prNativePacket, pucOutputBuf + ucTxDescLength);

        DBGLOG(INIT, INFO, ("TX SEC Frame: BSS[%u] STA_REC[%u] WLAN_IDX[%u] LEN[%u]\n", 
            prCmdInfo->ucBssIndex,
            prCmdInfo->ucStaRecIndex,
				    HAL_MAC_TX_DESC_GET_WLAN_INDEX((P_HW_MAC_TX_DESC_T) &
								   pucOutputBuf[0]),
            ucTxDescLength + prCmdInfo->u2InfoBufLen));
        
	} else if (prCmdInfo->eCmdType == COMMAND_TYPE_MANAGEMENT_FRAME) {
		prMsduInfo = (P_MSDU_INFO_T) prCmdInfo->prPacket;

        ASSERT(prMsduInfo->fgIs802_11 == TRUE);
        ASSERT(prMsduInfo->eSrc == TX_PACKET_MGMT);     

#if CFG_SUPPORT_MULTITHREAD
        nicTxCopyDesc(prAdapter, 
			      (P_HW_MAC_TX_DESC_T) &pucOutputBuf[0],
			      (P_HW_MAC_TX_DESC_T) prMsduInfo->ucTxDescBuffer, &ucTxDescLength);
#else
        nicTxFillDesc(prAdapter, prMsduInfo, &pucOutputBuf[0], &ucTxDescLength);
#endif

        u2OverallBufferLength = 
		    ucTxDescLength + NIC_TX_DESC_PADDING_LENGTH + prMsduInfo->u2FrameLength;

		/*                     */
        kalMemCopy(pucOutputBuf + ucTxDescLength + NIC_TX_DESC_PADDING_LENGTH,
			   prMsduInfo->prPacket, prMsduInfo->u2FrameLength);

		/*                                      */
        GLUE_DEC_REF_CNT(prTxCtrl->i4TxMgmtPendingNum);

		DBGLOG(INIT, INFO,
		       ("TX MGMT Frame: BSS[%u] WIDX:PID[%u:%u] SEQ[%u] STA[%u] LEN[%u] RSP[%u]\n",
			prCmdInfo->ucBssIndex, prMsduInfo->ucWlanIndex, prMsduInfo->ucPID,
			prMsduInfo->ucTxSeqNum, prMsduInfo->ucStaRecIndex, u2OverallBufferLength,
			prMsduInfo->pfTxDoneHandler ? TRUE : FALSE));

        if (prMsduInfo->pfTxDoneHandler) {
			/*                                                                         */
            KAL_ACQUIRE_SPIN_LOCK(prAdapter, SPIN_LOCK_TXING_MGMT_LIST);
			QUEUE_INSERT_TAIL(&(prTxCtrl->rTxMgmtTxingQueue),
					  (P_QUE_ENTRY_T) prMsduInfo);
            KAL_RELEASE_SPIN_LOCK(prAdapter, SPIN_LOCK_TXING_MGMT_LIST);            
		} else {
            cnmMgtPktFree(prAdapter, prMsduInfo);
        }
         
	} else {
		prWifiCmd = (P_WIFI_CMD_T) prCmdInfo->pucInfoBuffer;

		/*                                                                  */
		u2OverallBufferLength = TFCB_FRAME_PAD_TO_DW((prCmdInfo->
							      u2InfoBufLen) & (UINT_16)
							     HIF_TX_HDR_TX_BYTE_COUNT_MASK);

        prWifiCmd->u2TxByteCount = u2OverallBufferLength;
        prWifiCmd->u2PQ_ID = CMD_PQ_ID;
		prWifiCmd->ucPktTypeID = CMD_PACKET_TYPE_ID;

		/*                                                                         */
		kalMemCopy((PVOID) & pucOutputBuf[0],
			   (PVOID) prCmdInfo->pucInfoBuffer, prCmdInfo->u2InfoBufLen);

        ASSERT(u2OverallBufferLength <= prAdapter->u4CoalescingBufCachedSize);
        
        DBGLOG(INIT, INFO, ("TX CMD: ID[0x%02X] SEQ[%u] SET[%u] LEN[%u]\n", 
            prWifiCmd->ucCID,
            prWifiCmd->ucSeqNum,
				    prWifiCmd->ucSetQuery, u2OverallBufferLength));
    }

	/*                              */
    HAL_WRITE_TX_PORT(prAdapter,
			  (UINT_32) u2OverallBufferLength,
			  (PUINT_8) pucOutputBuf, (UINT_32) prAdapter->u4CoalescingBufCachedSize);

    return WLAN_STATUS_SUCCESS;
} /*                   */


/*                                                                            */
/* 
                                                                                 
                                                       
 
                                                     
 
                
*/
/*                                                                            */
VOID nicTxRelease(IN P_ADAPTER_T prAdapter, IN BOOLEAN fgProcTxDoneHandler)
{
    P_TX_CTRL_T prTxCtrl;
    P_MSDU_INFO_T prMsduInfo;

    KAL_SPIN_LOCK_DECLARATION();

    ASSERT(prAdapter);

    prTxCtrl = &prAdapter->rTxCtrl;

    nicTxFlush(prAdapter);

	/*                                           */
    do {
        KAL_ACQUIRE_SPIN_LOCK(prAdapter, SPIN_LOCK_TXING_MGMT_LIST);
        QUEUE_REMOVE_HEAD(&prTxCtrl->rTxMgmtTxingQueue, prMsduInfo, P_MSDU_INFO_T);
        KAL_RELEASE_SPIN_LOCK(prAdapter, SPIN_LOCK_TXING_MGMT_LIST);

		if (prMsduInfo) {
            DBGLOG(TX, INFO, ("%s: Get Msdu WIDX:PID[%u:%u] SEQ[%u] from Pending Q\n", 
					  __func__,
                prMsduInfo->ucWlanIndex, 
					  prMsduInfo->ucPID, prMsduInfo->ucTxSeqNum));
            
			/*                     */
			if (prMsduInfo->pfTxDoneHandler && fgProcTxDoneHandler) {
				prMsduInfo->pfTxDoneHandler(prAdapter, prMsduInfo,
							    TX_RESULT_DROPPED_IN_DRIVER);
            }

            cnmMgtPktFree(prAdapter, prMsduInfo);
		} else {
            break;
        }
	} while (TRUE);

    return;
} /*                       */

VOID nicTxInterruptSanityCheck(IN P_ADAPTER_T prAdapter, 
    IN UINT_16 *au2TxRlsCnt) 
{
    UINT_8 ucIdx;
    BOOLEAN fgError = FALSE;

    if(prAdapter->rWifiVar.ucTxDbg & BIT(1)) {
        for(ucIdx = HIF_TX_AC0_INDEX; ucIdx < HIF_TX_NUM; ucIdx++) {
            if(au2TxRlsCnt[ucIdx] > CFG_MAX_TX_PAGE_COUNT) {
                fgError = TRUE;   
            }
        }

        if(fgError)
            DBGLOG(TX, ERROR, ("Tx Done INT result, FFA[%u] AC[%u:%u:%u:%u:%u] CPU[%u]\n", 
                au2TxRlsCnt[HIF_TX_FFA_INDEX], au2TxRlsCnt[HIF_TX_AC0_INDEX],
                au2TxRlsCnt[HIF_TX_AC1_INDEX], au2TxRlsCnt[HIF_TX_AC2_INDEX],
                au2TxRlsCnt[HIF_TX_AC3_INDEX], au2TxRlsCnt[HIF_TX_AC4_INDEX], 
                au2TxRlsCnt[HIF_TX_CPU_INDEX]));    
    }
}


/*                                                                            */
/* 
                                                                            
                                 
 
                                                     
 
                
*/
/*                                                                            */
VOID nicProcessTxInterrupt(IN P_ADAPTER_T prAdapter)
{
    P_TX_CTRL_T prTxCtrl;
#if CFG_SDIO_INTR_ENHANCE
    P_SDIO_CTRL_T prSDIOCtrl;
#else
    UINT_32 au4TxCount[2];
#endif /*                       */

    ASSERT(prAdapter);

    prTxCtrl = &prAdapter->rTxCtrl;
    ASSERT(prTxCtrl);

     /*                   */
#if CFG_SDIO_INTR_ENHANCE

    prSDIOCtrl = prAdapter->prSDIOCtrl;
#if DBG
	/*                                                        */
#endif

    nicTxInterruptSanityCheck(prAdapter, (PUINT_16)&prSDIOCtrl->rTxInfo);
	nicTxReleaseResource(prAdapter, (PUINT_16)&prSDIOCtrl->rTxInfo);
    kalMemZero(&prSDIOCtrl->rTxInfo, sizeof(prSDIOCtrl->rTxInfo));

#else

    HAL_MCR_RD(prAdapter, MCR_WTSR0, &au4TxCount[0]);
    HAL_MCR_RD(prAdapter, MCR_WTSR1, &au4TxCount[1]);
    DBGLOG(EMU, TRACE, ("MCR_WTSR0: 0x%x, MCR_WTSR1: 0x%x\n", au4TxCount[0], au4TxCount[1]));

	nicTxReleaseResource(prAdapter, (PUINT_8) au4TxCount);

#endif /*                       */

    nicTxAdjustTcq(prAdapter);

	/*                         */
	if (kalGetTxPendingCmdCount(prAdapter->prGlueInfo) > 0
            || wlanGetTxPendingFrameCount(prAdapter) > 0) {
        kalSetEvent(prAdapter->prGlueInfo);
    }

    return;
} /*                                */


/*                                                                            */
/* 
                                                                
 
                                                                 
                                                            
 
                
*/
/*                                                                            */
VOID nicTxFreeMsduInfoPacket(IN P_ADAPTER_T prAdapter, IN P_MSDU_INFO_T prMsduInfoListHead)
{
    P_NATIVE_PACKET prNativePacket;
    P_MSDU_INFO_T prMsduInfo = prMsduInfoListHead;
    P_TX_CTRL_T prTxCtrl;


    ASSERT(prAdapter);
    ASSERT(prMsduInfoListHead);

    prTxCtrl = &prAdapter->rTxCtrl;

	while (prMsduInfo) {
        prNativePacket = prMsduInfo->prPacket;

		if (prMsduInfo->eSrc == TX_PACKET_OS) {
			kalSendComplete(prAdapter->prGlueInfo, prNativePacket, WLAN_STATUS_FAILURE);
		} else if (prMsduInfo->eSrc == TX_PACKET_MGMT) {
            if (prMsduInfo->pfTxDoneHandler) {
				prMsduInfo->pfTxDoneHandler(prAdapter, prMsduInfo,
							    TX_RESULT_DROPPED_IN_DRIVER);
            }
            cnmMemFree(prAdapter, prNativePacket);
		} else if (prMsduInfo->eSrc == TX_PACKET_FORWARDING) {
            GLUE_DEC_REF_CNT(prTxCtrl->i4PendingFwdFrameCount);
        }

		prMsduInfo = (P_MSDU_INFO_T) QUEUE_GET_NEXT_ENTRY((P_QUE_ENTRY_T) prMsduInfo);
    }

    return;
}

/*                                                                            */
/* 
                                                                                         
 
                                                                 
                                                            
 
                
*/
/*                                                                            */
VOID nicTxReturnMsduInfo(IN P_ADAPTER_T prAdapter, IN P_MSDU_INFO_T prMsduInfoListHead)
{
    P_TX_CTRL_T prTxCtrl;
    P_MSDU_INFO_T prMsduInfo = prMsduInfoListHead, prNextMsduInfo;

    KAL_SPIN_LOCK_DECLARATION();

    ASSERT(prAdapter);

    prTxCtrl = &prAdapter->rTxCtrl;
    ASSERT(prTxCtrl);

	while (prMsduInfo) {
		prNextMsduInfo = (P_MSDU_INFO_T) QUEUE_GET_NEXT_ENTRY((P_QUE_ENTRY_T) prMsduInfo);

		switch (prMsduInfo->eSrc) {
        case TX_PACKET_FORWARDING:
            wlanReturnPacket(prAdapter, prMsduInfo->prPacket);
            break;
        case TX_PACKET_OS:
        case TX_PACKET_OS_OID:
        case TX_PACKET_MGMT:
        default:
            break;
        }

        /*                        */
        kalMemZero(prMsduInfo, sizeof(MSDU_INFO_T));

        KAL_ACQUIRE_SPIN_LOCK(prAdapter, SPIN_LOCK_TX_MSDU_INFO_LIST);
		QUEUE_INSERT_TAIL(&prTxCtrl->rFreeMsduInfoList, (P_QUE_ENTRY_T) prMsduInfo);
        KAL_RELEASE_SPIN_LOCK(prAdapter, SPIN_LOCK_TX_MSDU_INFO_LIST);
        prMsduInfo = prNextMsduInfo;
    };

    return;
}



/*                                                                            */
/* 
                                                                
 
                                                                 
                                             
                                               
 
                                                  
                                                       
*/
/*                                                                            */
BOOLEAN
nicTxFillMsduInfo(IN P_ADAPTER_T prAdapter,
		  IN P_MSDU_INFO_T prMsduInfo, IN P_NATIVE_PACKET prPacket)
{
    P_GLUE_INFO_T   prGlueInfo;
    UINT_8          aucEthDestAddr[PARAM_MAC_ADDR_LEN];

    ASSERT(prAdapter);

    prGlueInfo = prAdapter->prGlueInfo;
    ASSERT(prGlueInfo); 
	
    kalGetEthDestAddr(prAdapter->prGlueInfo, prPacket, aucEthDestAddr);    

    prMsduInfo->prPacket = prPacket;
    prMsduInfo->fgIs802_1x = GLUE_GET_PKT_IS_1X(prPacket);
    prMsduInfo->fgIs802_11 = FALSE;
    prMsduInfo->fgIs802_3 = GLUE_GET_PKT_IS_802_3(prPacket);
    prMsduInfo->fgIsVlanExists = GLUE_GET_PKT_IS_VLAN_EXIST(prPacket);
    prMsduInfo->ucBssIndex = GLUE_GET_PKT_BSS_IDX(prPacket);
    prMsduInfo->ucUserPriority = GLUE_GET_PKT_TID(prPacket);
    prMsduInfo->ucMacHeaderLength = GLUE_GET_PKT_HEADER_LEN(prPacket);
	prMsduInfo->u2FrameLength = (UINT_16) GLUE_GET_PKT_FRAME_LEN(prPacket);
    prMsduInfo->ucPageCount = nicTxGetPageCount(prMsduInfo->u2FrameLength, FALSE);
    prMsduInfo->pfTxDoneHandler = NULL;
    prMsduInfo->ucPID = NIC_TX_DESC_PID_RESERVED;
    
    COPY_MAC_ADDR(prMsduInfo->aucEthDestAddr, aucEthDestAddr);

    /*                        */
    prMsduInfo->fgIsTXDTemplateValid = FALSE;
    prMsduInfo->ucPacketType = TX_PACKET_TYPE_DATA;
  
    return TRUE;
}


/*                                                                            */
/* 
                                                                                      
 
                                                                 
 
                                                    
*/
/*                                                                            */
WLAN_STATUS nicTxAdjustTcq(IN P_ADAPTER_T prAdapter)
{
#if CFG_SUPPORT_MULTITHREAD
    TX_TCQ_ADJUST_T rTcqAdjust;
    P_TX_CTRL_T prTxCtrl;
    
    ASSERT(prAdapter);
    
    prTxCtrl = &prAdapter->rTxCtrl;
    ASSERT(prTxCtrl);
    
    qmAdjustTcQuotasMthread(prAdapter, &rTcqAdjust, &prTxCtrl->rTc);

#else

    UINT_32 u4Num;
    TX_TCQ_ADJUST_T rTcqAdjust;
    P_TX_CTRL_T prTxCtrl;
    P_TX_TCQ_STATUS_T prTcqStatus;
    KAL_SPIN_LOCK_DECLARATION();
    
    ASSERT(prAdapter);

    prTxCtrl = &prAdapter->rTxCtrl;
    prTcqStatus = &prAdapter->rTxCtrl.rTc;        
    ASSERT(prTxCtrl);

	if (qmAdjustTcQuotas(prAdapter, &rTcqAdjust, &prTxCtrl->rTc)) {
        
        KAL_ACQUIRE_SPIN_LOCK(prAdapter, SPIN_LOCK_TX_RESOURCE);

        for (u4Num = 0 ; u4Num < TC_NUM ; u4Num++) {
            /*            */
			prTxCtrl->rTc.au2FreePageCount[u4Num] +=
			    (rTcqAdjust.acVariation[u4Num] * NIC_TX_MAX_PAGE_PER_FRAME);
			prTxCtrl->rTc.au2MaxNumOfPage[u4Num] +=
			    (rTcqAdjust.acVariation[u4Num] * NIC_TX_MAX_PAGE_PER_FRAME);

            /*              */
            prTxCtrl->rTc.au2FreeBufferCount[u4Num] += rTcqAdjust.acVariation[u4Num];
            prTxCtrl->rTc.au2MaxNumOfBuffer[u4Num] += rTcqAdjust.acVariation[u4Num];

            ASSERT(prTxCtrl->rTc.au2FreeBufferCount[u4Num] >= 0);
            ASSERT(prTxCtrl->rTc.au2MaxNumOfBuffer[u4Num] >= 0);
        }

        KAL_RELEASE_SPIN_LOCK(prAdapter, SPIN_LOCK_TX_RESOURCE);
#if 0        
		DBGLOG(TX, LOUD,
		       ("TCQ Status Free Page:Buf[%03u:%02u, %03u:%02u, %03u:%02u, %03u:%02u, %03u:%02u, %03u:%02u]\n",
            prTcqStatus->au2FreePageCount[TC0_INDEX],
            prTcqStatus->au2FreeBufferCount[TC0_INDEX],
            prTcqStatus->au2FreePageCount[TC1_INDEX],
            prTcqStatus->au2FreeBufferCount[TC1_INDEX],
            prTcqStatus->au2FreePageCount[TC2_INDEX],
            prTcqStatus->au2FreeBufferCount[TC2_INDEX],
            prTcqStatus->au2FreePageCount[TC3_INDEX],
            prTcqStatus->au2FreeBufferCount[TC3_INDEX],
            prTcqStatus->au2FreePageCount[TC4_INDEX],
            prTcqStatus->au2FreeBufferCount[TC4_INDEX],     
            prTcqStatus->au2FreePageCount[TC5_INDEX],
            prTcqStatus->au2FreeBufferCount[TC5_INDEX]));
#endif
		DBGLOG(TX, LOUD,
		       ("TCQ Status Max Page:Buf[%03u:%02u, %03u:%02u, %03u:%02u, %03u:%02u, %03u:%02u, %03u:%02u]\n",
            prTcqStatus->au2MaxNumOfPage[TC0_INDEX],
            prTcqStatus->au2MaxNumOfBuffer[TC0_INDEX],
            prTcqStatus->au2MaxNumOfPage[TC1_INDEX],
            prTcqStatus->au2MaxNumOfBuffer[TC1_INDEX],
            prTcqStatus->au2MaxNumOfPage[TC2_INDEX],
            prTcqStatus->au2MaxNumOfBuffer[TC2_INDEX],
            prTcqStatus->au2MaxNumOfPage[TC3_INDEX],
            prTcqStatus->au2MaxNumOfBuffer[TC3_INDEX],
            prTcqStatus->au2MaxNumOfPage[TC4_INDEX],
            prTcqStatus->au2MaxNumOfBuffer[TC4_INDEX],     
            prTcqStatus->au2MaxNumOfPage[TC5_INDEX],
            prTcqStatus->au2MaxNumOfBuffer[TC5_INDEX]));

    }
#endif
    return WLAN_STATUS_SUCCESS;
}


/*                                                                            */
/* 
                                                                 
 
                                                                 
 
                                                    
*/
/*                                                                            */

WLAN_STATUS nicTxFlush(IN P_ADAPTER_T prAdapter)
{
    P_MSDU_INFO_T prMsduInfo;
    KAL_SPIN_LOCK_DECLARATION();

    ASSERT(prAdapter);

	/*                                                                   */
    KAL_ACQUIRE_SPIN_LOCK(prAdapter, SPIN_LOCK_QM_TX_QUEUE);
    prMsduInfo = qmFlushTxQueues(prAdapter);
    KAL_RELEASE_SPIN_LOCK(prAdapter, SPIN_LOCK_QM_TX_QUEUE);

	if (prMsduInfo != NULL) {
        nicTxFreeMsduInfoPacket(prAdapter, prMsduInfo);
        nicTxReturnMsduInfo(prAdapter, prMsduInfo);
    }

    return WLAN_STATUS_SUCCESS;
}


#if CFG_ENABLE_FW_DOWNLOAD
/*                                                                            */
/* 
                                                                    
                                                    
 
                                                                                       
 
                                                         
                                             
                                                  
 
                                              
                                                
*/
/*                                                                            */
WLAN_STATUS nicTxInitCmd(IN P_ADAPTER_T prAdapter, IN P_CMD_INFO_T prCmdInfo)
{
    UINT_16 u2OverallBufferLength;
	PUINT_8 pucOutputBuf = (PUINT_8) NULL;	/*                                          */
    P_TX_CTRL_T prTxCtrl;

    ASSERT(prAdapter);
    ASSERT(prCmdInfo);

    prTxCtrl = &prAdapter->rTxCtrl;
    pucOutputBuf = prTxCtrl->pucTxCoalescingBufPtr;
	u2OverallBufferLength = TFCB_FRAME_PAD_TO_DW((prCmdInfo->
						      u2InfoBufLen) & (UINT_16)
						     HIF_TX_HDR_TX_BYTE_COUNT_MASK);

	/*                                                                         */
	kalMemCopy((PVOID) & pucOutputBuf[0],
		   (PVOID) prCmdInfo->pucInfoBuffer, prCmdInfo->u2InfoBufLen);

    ASSERT(u2OverallBufferLength <= prAdapter->u4CoalescingBufCachedSize);

	/*                              */
    HAL_WRITE_TX_PORT(prAdapter,
			  (UINT_32) u2OverallBufferLength,
			  (PUINT_8) pucOutputBuf, (UINT_32) prAdapter->u4CoalescingBufCachedSize);

    return WLAN_STATUS_SUCCESS;
}


/*                                                                            */
/* 
                                                                                
                              
 
                                                         
 
                                                           
*/
/*                                                                            */
WLAN_STATUS nicTxInitResetResource(IN P_ADAPTER_T prAdapter)
{
    P_TX_CTRL_T prTxCtrl;
    UINT_8 ucIdx;

    DEBUGFUNC("nicTxInitResetResource");

    ASSERT(prAdapter);
    prTxCtrl = &prAdapter->rTxCtrl;

    /*                  */
    kalMemZero(prTxCtrl->rTc.au2TxDonePageCount, sizeof(prTxCtrl->rTc.au2TxDonePageCount));   
    kalMemZero(prTxCtrl->rTc.au2PreUsedPageCount, sizeof(prTxCtrl->rTc.au2PreUsedPageCount));
    prTxCtrl->rTc.ucNextTcIdx = TC0_INDEX;
    prTxCtrl->rTc.u2AvaliablePageCount = 0;

    /*            */
    prTxCtrl->rTc.au2MaxNumOfPage[TC0_INDEX] = NIC_TX_INIT_PAGE_COUNT_TC0;
    prTxCtrl->rTc.au2FreePageCount[TC0_INDEX] = NIC_TX_INIT_PAGE_COUNT_TC0;

    prTxCtrl->rTc.au2MaxNumOfPage[TC1_INDEX] = NIC_TX_INIT_PAGE_COUNT_TC1;
    prTxCtrl->rTc.au2FreePageCount[TC1_INDEX] = NIC_TX_INIT_PAGE_COUNT_TC1;

    prTxCtrl->rTc.au2MaxNumOfPage[TC2_INDEX] = NIC_TX_INIT_PAGE_COUNT_TC2;
    prTxCtrl->rTc.au2FreePageCount[TC2_INDEX] = NIC_TX_INIT_PAGE_COUNT_TC2;

    prTxCtrl->rTc.au2MaxNumOfPage[TC3_INDEX] = NIC_TX_INIT_PAGE_COUNT_TC3;
    prTxCtrl->rTc.au2FreePageCount[TC3_INDEX] = NIC_TX_INIT_PAGE_COUNT_TC3;

    prTxCtrl->rTc.au2MaxNumOfPage[TC4_INDEX] = NIC_TX_INIT_PAGE_COUNT_TC4;
    prTxCtrl->rTc.au2FreePageCount[TC4_INDEX] = NIC_TX_INIT_PAGE_COUNT_TC4;

    prTxCtrl->rTc.au2MaxNumOfPage[TC5_INDEX] = NIC_TX_INIT_PAGE_COUNT_TC5;
    prTxCtrl->rTc.au2FreePageCount[TC5_INDEX] = NIC_TX_INIT_PAGE_COUNT_TC5;   

    /*              */
    for(ucIdx = TC0_INDEX; ucIdx < TC_NUM; ucIdx++) {
        prTxCtrl->rTc.au2MaxNumOfBuffer[ucIdx] = prTxCtrl->rTc.au2MaxNumOfPage[ucIdx] / NIC_TX_MAX_PAGE_PER_FRAME;
        prTxCtrl->rTc.au2FreeBufferCount[ucIdx] = prTxCtrl->rTc.au2FreePageCount[ucIdx] / NIC_TX_MAX_PAGE_PER_FRAME;
    }

    return WLAN_STATUS_SUCCESS;

}

#endif

VOID nicTxProcessMngPacket(IN P_ADAPTER_T prAdapter, IN P_MSDU_INFO_T prMsduInfo)
{
    UINT_16 u2RateCode;
    P_BSS_INFO_T prBssInfo;
    P_STA_RECORD_T prStaRec;

	if (prMsduInfo->eSrc != TX_PACKET_MGMT) {
        return;
    }

    prBssInfo = GET_BSS_INFO_BY_INDEX(prAdapter, prMsduInfo->ucBssIndex);
    prStaRec = cnmGetStaRecByIndex(prAdapter, prMsduInfo->ucStaRecIndex);

	/*                           */
    prMsduInfo->ucTC = TC4_INDEX;
    
	/*                                     */
    prMsduInfo->fgIsTXDTemplateValid = FALSE;

    /*            */
	if (prMsduInfo->ucRateMode == MSDU_RATE_MODE_AUTO) {
        prMsduInfo->ucRateMode = MSDU_RATE_MODE_MANUAL_DESC;

		if (prStaRec) {
            u2RateCode = prStaRec->u2HwDefaultFixedRateCode;
		} else {
            u2RateCode = prBssInfo->u2HwDefaultFixedRateCode;
        }

		nicTxSetPktFixedRateOption(prMsduInfo, u2RateCode, FIX_BW_NO_FIXED, FALSE, FALSE);
    }   
#if CFG_SUPPORT_MULTITHREAD
    nicTxFillDesc(prAdapter, prMsduInfo, prMsduInfo->ucTxDescBuffer, NULL);
#endif

    return;
}


/*                                                                            */
/* 
                                                                  
                         
 
                                                         
                                       
 
                                                           
*/
/*                                                                            */
WLAN_STATUS nicTxEnqueueMsdu(IN P_ADAPTER_T prAdapter, IN P_MSDU_INFO_T prMsduInfo)
{
    P_TX_CTRL_T prTxCtrl;
    P_MSDU_INFO_T prNextMsduInfo, prRetMsduInfo, prMsduInfoHead;
    QUE_T qDataPort0, qDataPort1;
    P_QUE_T prDataPort0, prDataPort1;
    P_CMD_INFO_T prCmdInfo;
    WLAN_STATUS u4Status = WLAN_STATUS_SUCCESS;
    KAL_SPIN_LOCK_DECLARATION();

    ASSERT(prAdapter);
    ASSERT(prMsduInfo);

    prTxCtrl = &prAdapter->rTxCtrl;
    ASSERT(prTxCtrl);

    prDataPort0 = &qDataPort0;
    prDataPort1 = &qDataPort1;

    QUEUE_INITIALIZE(prDataPort0);
    QUEUE_INITIALIZE(prDataPort1);

    /*                                                  */
	while (prMsduInfo) {
		prNextMsduInfo = (P_MSDU_INFO_T) QUEUE_GET_NEXT_ENTRY((P_QUE_ENTRY_T) prMsduInfo);

		QUEUE_GET_NEXT_ENTRY((P_QUE_ENTRY_T) prMsduInfo) = NULL;

		if (prMsduInfo->eSrc == TX_PACKET_MGMT) {
            nicTxProcessMngPacket(prAdapter, prMsduInfo);
			QUEUE_INSERT_TAIL(prDataPort1, (P_QUE_ENTRY_T) prMsduInfo);
		} else {
			QUEUE_INSERT_TAIL(prDataPort0, (P_QUE_ENTRY_T) prMsduInfo);
        }

        prMsduInfo = prNextMsduInfo;
    }

	if (prDataPort0->u4NumElem) {
        /*            */
        KAL_SPIN_LOCK_DECLARATION();
        KAL_ACQUIRE_SPIN_LOCK(prAdapter, SPIN_LOCK_QM_TX_QUEUE);
		prRetMsduInfo =
		    qmEnqueueTxPackets(prAdapter, (P_MSDU_INFO_T) QUEUE_GET_HEAD(prDataPort0));
        KAL_RELEASE_SPIN_LOCK(prAdapter, SPIN_LOCK_QM_TX_QUEUE);

        /*                                  */
		if (prRetMsduInfo) {	/*                   */
            nicTxFreeMsduInfoPacket(prAdapter, prRetMsduInfo);
            nicTxReturnMsduInfo(prAdapter, prRetMsduInfo);
        }
    }

	if (prDataPort1->u4NumElem) {
		prMsduInfoHead = (P_MSDU_INFO_T) QUEUE_GET_HEAD(prDataPort1);

		if (nicTxGetFreeCmdCount(prAdapter) < NIC_TX_CMD_INFO_RESERVED_COUNT) {
			/*                                    */
            u4Status = WLAN_STATUS_FAILURE;

			/*                */
			while (prMsduInfoHead) {
				prNextMsduInfo =
				    (P_MSDU_INFO_T) QUEUE_GET_NEXT_ENTRY(&prMsduInfoHead->
									 rQueEntry);

                if (prMsduInfoHead->pfTxDoneHandler != NULL) {
					prMsduInfoHead->pfTxDoneHandler(prAdapter, prMsduInfoHead,
									TX_RESULT_DROPPED_IN_DRIVER);
                }

                cnmMgtPktFree(prAdapter, prMsduInfoHead);

                prMsduInfoHead = prNextMsduInfo;
            }
		} else {
            /*                       */
			while (prMsduInfoHead) {
				prNextMsduInfo =
				    (P_MSDU_INFO_T) QUEUE_GET_NEXT_ENTRY(&prMsduInfoHead->
									 rQueEntry);

                KAL_ACQUIRE_SPIN_LOCK(prAdapter, SPIN_LOCK_CMD_RESOURCE);
				QUEUE_REMOVE_HEAD(&prAdapter->rFreeCmdList, prCmdInfo,
						  P_CMD_INFO_T);
                KAL_RELEASE_SPIN_LOCK(prAdapter, SPIN_LOCK_CMD_RESOURCE);

                if (prCmdInfo) {
                    GLUE_INC_REF_CNT(prTxCtrl->i4TxMgmtPendingNum);

                    kalMemZero(prCmdInfo, sizeof(CMD_INFO_T));

                    prCmdInfo->eCmdType             = COMMAND_TYPE_MANAGEMENT_FRAME;
                    prCmdInfo->u2InfoBufLen         = prMsduInfoHead->u2FrameLength;
                    prCmdInfo->pucInfoBuffer        = NULL;
					prCmdInfo->prPacket = (P_NATIVE_PACKET) prMsduInfoHead;
                    prCmdInfo->ucStaRecIndex        = prMsduInfoHead->ucStaRecIndex;
                    prCmdInfo->ucBssIndex           = prMsduInfoHead->ucBssIndex;
                    prCmdInfo->pfCmdDoneHandler     = NULL;
                    prCmdInfo->pfCmdTimeoutHandler  = NULL;
                    prCmdInfo->fgIsOid              = FALSE;
                    prCmdInfo->fgSetQuery           = TRUE;
                    prCmdInfo->fgNeedResp           = FALSE;
                    prCmdInfo->ucCmdSeqNum          = prMsduInfoHead->ucTxSeqNum;
                    
					DBGLOG(TX, INFO,
					       ("%s: EN-Q MSDU[0x%p] SEQ[%u] BSS[%u] STA[%u] to CMD Q\n",
						__func__, prMsduInfoHead,
                        prMsduInfoHead->ucTxSeqNum,
                        prMsduInfoHead->ucBssIndex,
                        prMsduInfoHead->ucStaRecIndex));
    
					kalEnqueueCommand(prAdapter->prGlueInfo,
							  (P_QUE_ENTRY_T) prCmdInfo);
				} else {
                    /*                                                              */
                    u4Status = WLAN_STATUS_FAILURE;

                    if (prMsduInfoHead->pfTxDoneHandler != NULL) {
						prMsduInfoHead->pfTxDoneHandler(prAdapter,
										prMsduInfoHead,
										TX_RESULT_DROPPED_IN_DRIVER);
                    }
                    
                    cnmMgtPktFree(prAdapter, prMsduInfoHead);
                }

                prMsduInfoHead = prNextMsduInfo;
            }
        }
    }

    /*                                     */
	if (prTxCtrl->i4TxMgmtPendingNum > 0
            || kalGetTxPendingFrameCount(prAdapter->prGlueInfo) > 0) {
        kalSetEvent(prAdapter->prGlueInfo);
    }

    return u4Status;
}

/*                                                                            */
/* 
                                         
 
                                                         
 
         
*/
/*                                                                            */
UINT_8 nicTxGetWlanIdx(P_ADAPTER_T prAdapter, UINT_8 ucBssIdx, UINT_8 ucStaRecIdx)
{
    P_STA_RECORD_T prStaRec;
    P_BSS_INFO_T prBssInfo;
    UINT_8 ucWlanIndex = NIC_TX_DEFAULT_WLAN_INDEX;

    prStaRec = cnmGetStaRecByIndex(prAdapter, ucStaRecIdx);
    prBssInfo = GET_BSS_INFO_BY_INDEX(prAdapter, ucBssIdx);

	if (prStaRec) {
        ASSERT(prStaRec->ucWlanIndex < WTBL_SIZE);
        ucWlanIndex = prStaRec->ucWlanIndex;
	} else if (ucStaRecIdx == STA_REC_INDEX_BMCAST) {
        ASSERT(prBssInfo->ucBMCWlanIndex < WTBL_SIZE);
        ucWlanIndex = prBssInfo->ucBMCWlanIndex;        
	} else {
        ucWlanIndex = NIC_TX_DEFAULT_WLAN_INDEX;
    }

    return ucWlanIndex;
}

/*                                                                            */
/* 
                                                               
 
                                                         
 
         
*/
/*                                                                            */
UINT_32 nicTxGetFreeCmdCount(IN P_ADAPTER_T prAdapter)
{
    ASSERT(prAdapter);

    return prAdapter->rFreeCmdList.u4NumElem;
}

/*                                                                            */
/* 
                                                  
 
                                        
 
                                  
*/
/*                                                                            */
UINT_8 nicTxGetPageCount(IN UINT_32 u4FrameLength, IN BOOLEAN fgIncludeDesc)
{
    UINT_32 u4RequiredBufferSize;
    UINT_8  ucPageCount;

  /*             
                                                                                                                     
    */

	if (fgIncludeDesc) {
        u4RequiredBufferSize = u4FrameLength;
	} else {
        u4RequiredBufferSize = 
		    NIC_TX_DESC_LONG_FORMAT_LENGTH + NIC_TX_DESC_PADDING_LENGTH + u4FrameLength;
    }

	if (NIC_TX_PAGE_SIZE_IS_POWER_OF_2) {
		ucPageCount =
		    (UINT_8) ((u4RequiredBufferSize +
			       (NIC_TX_PAGE_SIZE - 1)) >> NIC_TX_PAGE_SIZE_IN_POWER_OF_2);
	} else {
		ucPageCount =
		    (UINT_8) ((u4RequiredBufferSize + (NIC_TX_PAGE_SIZE - 1)) / NIC_TX_PAGE_SIZE);
    }

    return ucPageCount;
}

UINT_8 nicTxGetCmdPageCount(IN P_CMD_INFO_T prCmdInfo)
{
    UINT_8 ucPageCount;

	switch (prCmdInfo->eCmdType) {
        case COMMAND_TYPE_NETWORK_IOCTL:
        case COMMAND_TYPE_GENERAL_IOCTL:
            ucPageCount = nicTxGetPageCount(prCmdInfo->u2InfoBufLen, TRUE);
            break;
            
        case COMMAND_TYPE_SECURITY_FRAME:
        case COMMAND_TYPE_MANAGEMENT_FRAME:
            ucPageCount = nicTxGetPageCount(prCmdInfo->u2InfoBufLen, FALSE);
            break;

        default:
            DBGLOG(INIT, WARN, ("Undefined CMD Type(%u)\n", prCmdInfo->eCmdType));
            ucPageCount = nicTxGetPageCount(prCmdInfo->u2InfoBufLen, FALSE);
            break;
    }

    return ucPageCount;
}

VOID 
nicTxSetMngPacket(P_ADAPTER_T prAdapter,
    P_MSDU_INFO_T           prMsduInfo,
    UINT_8                  ucBssIndex,
    UINT_8                  ucStaRecIndex,
    UINT_8                  ucMacHeaderLength,
		  UINT_16 u2FrameLength, PFN_TX_DONE_HANDLER pfTxDoneHandler, UINT_8 ucRateMode)
{
    ASSERT(prMsduInfo);

    prMsduInfo->ucBssIndex = ucBssIndex;
    prMsduInfo->ucStaRecIndex = ucStaRecIndex;
    prMsduInfo->ucMacHeaderLength = ucMacHeaderLength;
    prMsduInfo->u2FrameLength = u2FrameLength;
    prMsduInfo->pfTxDoneHandler = pfTxDoneHandler;
    prMsduInfo->ucRateMode = ucRateMode;

    /*                               */
    prMsduInfo->fgIs802_11 = TRUE;
    prMsduInfo->fgIs802_1x = FALSE;    
    prMsduInfo->u4FixedRateOption = 0;
    prMsduInfo->cPowerOffset = 0;
    prMsduInfo->u4Option = 0;
    prMsduInfo->ucTxSeqNum = nicIncreaseTxSeqNum(prAdapter);
    prMsduInfo->ucPID = NIC_TX_DESC_PID_RESERVED;
    prMsduInfo->ucPacketType = TX_PACKET_TYPE_MGMT;
    prMsduInfo->ucUserPriority = 0;
    prMsduInfo->eSrc = TX_PACKET_MGMT;
}

VOID
nicTxSetDataPacket(P_ADAPTER_T prAdapter,
    P_MSDU_INFO_T           prMsduInfo,
    UINT_8                  ucBssIndex, 
    UINT_8                  ucStaRecIndex,
    UINT_8                  ucMacHeaderLength,
    UINT_16                 u2FrameLength,
    PFN_TX_DONE_HANDLER     pfTxDoneHandler,
    UINT_8                  ucRateMode,
    ENUM_TX_PACKET_SRC_T    eSrc,    
		   UINT_8 ucTID, BOOLEAN fgIs802_11Frame, BOOLEAN fgIs1xFrame)
{
    ASSERT(prMsduInfo);

    prMsduInfo->ucBssIndex = ucBssIndex;
    prMsduInfo->ucStaRecIndex = ucStaRecIndex;
    prMsduInfo->ucMacHeaderLength = ucMacHeaderLength;
    prMsduInfo->u2FrameLength = u2FrameLength;
    prMsduInfo->pfTxDoneHandler = pfTxDoneHandler;
    prMsduInfo->ucRateMode = ucRateMode;
    prMsduInfo->ucUserPriority = ucTID;
    prMsduInfo->fgIs802_11 = fgIs802_11Frame;
    prMsduInfo->eSrc = eSrc;
    prMsduInfo->fgIs802_1x = fgIs1xFrame;    

    /*                                     */
    prMsduInfo->u4FixedRateOption = 0;
    prMsduInfo->cPowerOffset = 0;
    prMsduInfo->u4Option = 0;
    prMsduInfo->ucTxSeqNum = nicIncreaseTxSeqNum(prAdapter);
    prMsduInfo->ucPID = NIC_TX_DESC_PID_RESERVED;
    prMsduInfo->ucPacketType = TX_PACKET_TYPE_DATA;
}

VOID nicTxFillDescByPktOption(P_MSDU_INFO_T prMsduInfo, P_HW_MAC_TX_DESC_T prTxDesc)
{
    UINT_32 u4PktOption = prMsduInfo->u4Option;
    BOOLEAN fgIsLongFormat;
    BOOLEAN fgProtected = FALSE;

    /*                                         */
	if (!u4PktOption) {
        return;
    }

    fgIsLongFormat = HAL_MAC_TX_DESC_IS_LONG_FORMAT(prTxDesc);
    
    /*                                      */
	if (u4PktOption & MSDU_OPT_NO_ACK) {
        HAL_MAC_TX_DESC_SET_NO_ACK(prTxDesc);
    }

	if (u4PktOption & MSDU_OPT_PROTECTED_FRAME) {
        HAL_MAC_TX_DESC_SET_PROTECTION(prTxDesc);
        fgProtected = TRUE;
    }    

	switch (HAL_MAC_TX_DESC_GET_HEADER_FORMAT(prTxDesc)) {
        case HEADER_FORMAT_802_11_ENHANCE_MODE:
		if (u4PktOption & MSDU_OPT_EOSP) {
                HAL_MAC_TX_DESC_SET_EOSP(prTxDesc);
            }     

		if (u4PktOption & MSDU_OPT_AMSDU) {
                HAL_MAC_TX_DESC_SET_AMSDU(prTxDesc);
            }              
            break;
            
        case HEADER_FORMAT_NON_802_11:
		if (u4PktOption & MSDU_OPT_EOSP) {
                HAL_MAC_TX_DESC_SET_EOSP(prTxDesc);
            }

		if (u4PktOption & MSDU_OPT_MORE_DATA) {
                HAL_MAC_TX_DESC_SET_MORE_DATA(prTxDesc);
            }          

		if (u4PktOption & MSDU_OPT_REMOVE_VLAN) {
                HAL_MAC_TX_DESC_SET_REMOVE_VLAN(prTxDesc);
            }                                                     
            break;            

        case HEADER_FORMAT_802_11_NORMAL_MODE:
		if (fgProtected && prMsduInfo->prPacket) {
                P_WLAN_MAC_HEADER_T prWlanHeader = 
			    (P_WLAN_MAC_HEADER_T) ((ULONG) (prMsduInfo->prPacket) +
						   MAC_TX_RESERVED_FIELD);

                prWlanHeader->u2FrameCtrl |= MASK_FC_PROTECTED_FRAME;
            }
            break;
            
        default:
            break;            
    }        

	if (!fgIsLongFormat) {
        return;
    }

    /*                               */
	if (u4PktOption & MSDU_OPT_NO_AGGREGATE) {
        HAL_MAC_TX_DESC_SET_BA_DISABLE(prTxDesc);
    }

	if (u4PktOption & MSDU_OPT_TIMING_MEASURE) {
        HAL_MAC_TX_DESC_SET_TIMING_MEASUREMENT(prTxDesc);
    }

	if (u4PktOption & MSDU_OPT_NDP) {
        HAL_MAC_TX_DESC_SET_NDP(prTxDesc);
    }
    
	if (u4PktOption & MSDU_OPT_NDPA) {
        HAL_MAC_TX_DESC_SET_NDPA(prTxDesc);
    }
    
	if (u4PktOption & MSDU_OPT_SOUNDING) {
        HAL_MAC_TX_DESC_SET_SOUNDING_FRAME(prTxDesc);
    }
    
	if (u4PktOption & MSDU_OPT_FORCE_RTS) {
        HAL_MAC_TX_DESC_SET_FORCE_RTS_CTS(prTxDesc);
    }
    
	if (u4PktOption & MSDU_OPT_BIP) {
        HAL_MAC_TX_DESC_SET_BIP(prTxDesc);
    }

    /*          */    
	if (u4PktOption & MSDU_OPT_SW_DURATION) {
        HAL_MAC_TX_DESC_SET_DURATION_CONTROL_BY_SW(prTxDesc);
    }
    
	if (u4PktOption & MSDU_OPT_SW_PS_BIT) {
        HAL_MAC_TX_DESC_SET_SW_PM_CONTROL(prTxDesc);
    }
    
	if (u4PktOption & MSDU_OPT_SW_HTC) {
        HAL_MAC_TX_DESC_SET_HTC_EXIST(prTxDesc);
    }
    
	if (u4PktOption & MSDU_OPT_SW_BAR_SN) {
        HAL_MAC_TX_DESC_SET_SW_BAR_SSN(prTxDesc);
    }    

	if (u4PktOption & MSDU_OPT_MANUAL_SN) {
        HAL_MAC_TX_DESC_SET_TXD_SN_VALID(prTxDesc);
        HAL_MAC_TX_DESC_SET_SEQUENCE_NUMBER(prTxDesc, prMsduInfo->u2SwSN);
    }
    
}

/*                                                                            */
/* 
                                          
 
         
*/
/*                                                                            */
VOID nicTxConfigPktOption(P_MSDU_INFO_T prMsduInfo, UINT_32 u4OptionMask, BOOLEAN fgSetOption)
{
	if (fgSetOption) {
        prMsduInfo->u4Option |= u4OptionMask;
	} else {
        prMsduInfo->u4Option &= ~u4OptionMask;
    }
}

VOID nicTxFillDescByPktControl(P_MSDU_INFO_T prMsduInfo, P_HW_MAC_TX_DESC_T prTxDesc)
{
    UINT_8 ucPktControl = prMsduInfo->ucControlFlag;
    UINT_8 ucSwReserved;

    /*                                         */
	if (!ucPktControl) {
        return;
    }

	if (HAL_MAC_TX_DESC_IS_LONG_FORMAT(prTxDesc)) {
        ucSwReserved = HAL_MAC_TX_DESC_GET_SW_RESERVED(prTxDesc);
        
		if (ucPktControl & MSDU_CONTROL_FLAG_FORCE_TX) {
            ucSwReserved |= MSDU_CONTROL_FLAG_FORCE_TX;
        }

        HAL_MAC_TX_DESC_SET_SW_RESERVED(prTxDesc, ucSwReserved);
    }
}


VOID
nicTxConfigPktControlFlag(P_MSDU_INFO_T prMsduInfo, UINT_8 ucControlFlagMask, BOOLEAN fgSetFlag)
{
    /*                  */
	if (fgSetFlag) {
        prMsduInfo->ucControlFlag |= ucControlFlagMask;
    }
    /*                    */
    else {
        prMsduInfo->ucControlFlag &= ~ucControlFlagMask;
    }
}

VOID nicTxSetPktLifeTime(P_MSDU_INFO_T prMsduInfo, UINT_32 u4TxLifeTimeInMs)
{
    prMsduInfo->u4RemainingLifetime = u4TxLifeTimeInMs;
    prMsduInfo->u4Option |= MSDU_OPT_MANUAL_LIFE_TIME;
}

VOID nicTxSetPktRetryLimit(P_MSDU_INFO_T prMsduInfo, UINT_8 ucRetryLimit)
{
    prMsduInfo->ucRetryLimit = ucRetryLimit;
    prMsduInfo->u4Option |= MSDU_OPT_MANUAL_RETRY_LIMIT;
}

VOID nicTxSetPktPowerOffset(P_MSDU_INFO_T prMsduInfo, INT_8 cPowerOffset)
{
    prMsduInfo->cPowerOffset = cPowerOffset;
    prMsduInfo->u4Option |= MSDU_OPT_MANUAL_POWER_OFFSET;
}

VOID nicTxSetPktSequenceNumber(P_MSDU_INFO_T prMsduInfo, UINT_16 u2SN)
{
    prMsduInfo->u2SwSN = u2SN;
    prMsduInfo->u4Option |= MSDU_OPT_MANUAL_SN;
}

VOID nicTxSetPktMacTxQue(P_MSDU_INFO_T prMsduInfo, UINT_8 ucMacTxQue)
{
    UINT_8 ucTcIdx;

	for (ucTcIdx = TC0_INDEX; ucTcIdx < TC_NUM; ucTcIdx++) {
		if (arTcResourceControl[ucTcIdx].ucDestQueueIndex == ucMacTxQue) {
            break;
        }
    }

	if (ucTcIdx < TC_NUM) {
        prMsduInfo->ucTC = ucTcIdx;
        prMsduInfo->u4Option |= MSDU_OPT_MANUAL_TX_QUE;
    }
}

VOID
nicTxSetPktFixedRateOptionFull(P_MSDU_INFO_T prMsduInfo,
    UINT_16         u2RateCode,
    UINT_8          ucBandwidth,
    BOOLEAN         fgShortGI,
    BOOLEAN         fgLDPC,
    BOOLEAN         fgDynamicBwRts,
    BOOLEAN         fgSpatialExt,
    BOOLEAN         fgEtxBeamforming,
    BOOLEAN         fgItxBeamforming,
			       UINT_8 ucAntennaIndex, UINT_8 ucAntennaPriority)
{
    HW_MAC_TX_DESC_T rTxDesc;
    P_HW_MAC_TX_DESC_T prTxDesc = &rTxDesc;

    kalMemZero(prTxDesc, NIC_TX_DESC_LONG_FORMAT_LENGTH);

    /*                                         */
    HAL_MAC_TX_DESC_SET_FR_RATE(prTxDesc, u2RateCode);

	if (ucBandwidth) {
        HAL_MAC_TX_DESC_SET_FR_BW(prTxDesc, ucBandwidth);
    }

	if (fgShortGI) {
        HAL_MAC_TX_DESC_SET_FR_SHORT_GI(prTxDesc);
    }

	if (fgLDPC) {
        HAL_MAC_TX_DESC_SET_FR_LDPC(prTxDesc);
    }

	if (fgDynamicBwRts) {
        HAL_MAC_TX_DESC_SET_FR_DYNAMIC_BW_RTS(prTxDesc);
    }

	if (fgSpatialExt) {
        HAL_MAC_TX_DESC_SET_FR_SPE_EN(prTxDesc);
    }

	if (fgEtxBeamforming) {
        HAL_MAC_TX_DESC_SET_FR_ETX_BF(prTxDesc);
    }
    
	if (fgItxBeamforming) {
        HAL_MAC_TX_DESC_SET_FR_ITX_BF(prTxDesc);
    }    

    HAL_MAC_TX_DESC_SET_FR_ANTENNA_ID(prTxDesc, ucAntennaIndex);

    HAL_MAC_TX_DESC_SET_FR_ANTENNA_PRIORITY(prTxDesc, ucAntennaPriority);

    /*                                       */
    HAL_MAC_TX_DESC_GET_DW(prTxDesc, 6, 1, &prMsduInfo->u4FixedRateOption);

}

VOID
nicTxSetPktFixedRateOption(P_MSDU_INFO_T prMsduInfo,
    UINT_16         u2RateCode,
			   UINT_8 ucBandwidth, BOOLEAN fgShortGI, BOOLEAN fgDynamicBwRts)
{
    HW_MAC_TX_DESC_T rTxDesc;
    P_HW_MAC_TX_DESC_T prTxDesc = &rTxDesc;

    kalMemZero(prTxDesc, NIC_TX_DESC_LONG_FORMAT_LENGTH);

    /*                                         */    
    HAL_MAC_TX_DESC_SET_FR_RATE(prTxDesc, u2RateCode);

	if (ucBandwidth) {
        HAL_MAC_TX_DESC_SET_FR_BW(prTxDesc, ucBandwidth);
    }

	if (fgShortGI) {
        HAL_MAC_TX_DESC_SET_FR_SHORT_GI(prTxDesc);
    }

	if (fgDynamicBwRts) {
        HAL_MAC_TX_DESC_SET_FR_DYNAMIC_BW_RTS(prTxDesc);
    }

    /*                                       */
    HAL_MAC_TX_DESC_GET_DW(prTxDesc, 6, 1, &prMsduInfo->u4FixedRateOption);

}

VOID nicTxSetPktMoreData(P_MSDU_INFO_T prCurrentMsduInfo, BOOLEAN fgSetMoreDataBit)
{
    P_WLAN_MAC_HEADER_T prWlanMacHeader = NULL;

	if (prCurrentMsduInfo->fgIs802_11) {
		prWlanMacHeader =
		    (P_WLAN_MAC_HEADER_T) (((PUINT_8) (prCurrentMsduInfo->prPacket)) +
					   MAC_TX_RESERVED_FIELD);
    }
    
	if (fgSetMoreDataBit) {
		if (!prCurrentMsduInfo->fgIs802_11) {
            prCurrentMsduInfo->u4Option |= MSDU_OPT_MORE_DATA;
		} else {
            prWlanMacHeader->u2FrameCtrl |= MASK_FC_MORE_DATA;
        }
	} else {
		if (!prCurrentMsduInfo->fgIs802_11) {
            prCurrentMsduInfo->u4Option &= ~MSDU_OPT_MORE_DATA;
		} else {
            prWlanMacHeader->u2FrameCtrl &= ~MASK_FC_MORE_DATA;
        }
    }
}

UINT_8 nicTxAssignPID(IN P_ADAPTER_T prAdapter, IN UINT_8 ucWlanIndex)
{
    UINT_8 ucRetval;
    PUINT_8 pucPidPool;

    ASSERT(prAdapter);

    pucPidPool = &prAdapter->aucPidPool[ucWlanIndex];

    ucRetval = *pucPidPool;

    /*                                       */
    (*pucPidPool)++;

	if (*pucPidPool > NIC_TX_DESC_DRIVER_PID_MAX) {
        *pucPidPool = NIC_TX_DESC_DRIVER_PID_MIN;
    }

    return ucRetval;
}

VOID nicTxSetPktEOSP(P_MSDU_INFO_T prCurrentMsduInfo, BOOLEAN fgSetEOSPBit)
{
    P_WLAN_MAC_HEADER_QOS_T prWlanMacHeader = NULL;
    BOOLEAN fgWriteToDesc = TRUE;

	if (prCurrentMsduInfo->fgIs802_11) {
		prWlanMacHeader =
		    (P_WLAN_MAC_HEADER_QOS_T) (((PUINT_8) (prCurrentMsduInfo->prPacket)) +
					       MAC_TX_RESERVED_FIELD);
        fgWriteToDesc = FALSE;
    }
    
	if (fgSetEOSPBit) {
		if (fgWriteToDesc) {
            prCurrentMsduInfo->u4Option |= MSDU_OPT_EOSP;
		} else {
            prWlanMacHeader->u2QosCtrl |= MASK_QC_EOSP;
        }
	} else {
		if (fgWriteToDesc) {
            prCurrentMsduInfo->u4Option &= ~MSDU_OPT_EOSP;
		} else {
            prWlanMacHeader->u2QosCtrl &= ~MASK_QC_EOSP;
        }
    }
}

WLAN_STATUS
nicTxDummyTxDone(IN P_ADAPTER_T prAdapter,
		 IN P_MSDU_INFO_T prMsduInfo, IN ENUM_TX_RESULT_CODE_T rTxDoneStatus)
{
    DBGLOG(TX, TRACE, ("Msdu WIDX:PID[%u:%u] SEQ[%u] Tx Status[%u]\n", 
        prMsduInfo->ucWlanIndex,
			   prMsduInfo->ucPID, prMsduInfo->ucTxSeqNum, rTxDoneStatus));

    return WLAN_STATUS_SUCCESS;
}

/*                                                                            */
/* 
                             
 
                          
 
                
*/
/*                                                                            */
VOID nicTxUpdateBssDefaultRate(P_BSS_INFO_T prBssInfo)
{
    UINT_8              ucLowestBasicRateIndex;
    
    prBssInfo->u2HwDefaultFixedRateCode = RATE_OFDM_6M;
    
	/*                                                                 */
	if (rateGetLowestRateIndexFromRateSet
	    (prBssInfo->u2BSSBasicRateSet, &ucLowestBasicRateIndex)) {
		nicRateIndex2RateCode(PREAMBLE_DEFAULT_LONG_NONE, ucLowestBasicRateIndex,
            &prBssInfo->u2HwDefaultFixedRateCode);
	} else {
		switch (prBssInfo->ucNonHTBasicPhyType) {
            case PHY_TYPE_ERP_INDEX:
            case PHY_TYPE_OFDM_INDEX:
                prBssInfo->u2HwDefaultFixedRateCode = RATE_OFDM_6M;
                break;

            default:
                prBssInfo->u2HwDefaultFixedRateCode = RATE_CCK_1M_LONG;
                break;
        }
    }   
}

/*                                                                            */
/* 
                                    
 
                          
 
                
*/
/*                                                                            */
VOID nicTxUpdateStaRecDefaultRate(P_STA_RECORD_T prStaRec)
{
    UINT_8                      ucLowestBasicRateIndex;

    prStaRec->u2HwDefaultFixedRateCode = RATE_OFDM_6M;
     
	/*                                                                 */
    if (rateGetLowestRateIndexFromRateSet(prStaRec->u2BSSBasicRateSet, &ucLowestBasicRateIndex)) {
		nicRateIndex2RateCode(PREAMBLE_DEFAULT_LONG_NONE,
				      ucLowestBasicRateIndex, &prStaRec->u2HwDefaultFixedRateCode);
	} else {
        if (prStaRec->ucDesiredPhyTypeSet & PHY_TYPE_SET_802_11B) {
            prStaRec->u2HwDefaultFixedRateCode = RATE_CCK_1M_LONG;
		} else if (prStaRec->ucDesiredPhyTypeSet & PHY_TYPE_SET_802_11G) {
            prStaRec->u2HwDefaultFixedRateCode = RATE_OFDM_6M;
		} else if (prStaRec->ucDesiredPhyTypeSet & PHY_TYPE_SET_802_11A) {
            prStaRec->u2HwDefaultFixedRateCode = RATE_OFDM_6M;
		} else if (prStaRec->ucDesiredPhyTypeSet & PHY_TYPE_SET_802_11N) {
            prStaRec->u2HwDefaultFixedRateCode = RATE_MM_MCS_0;
        }
    }
}
